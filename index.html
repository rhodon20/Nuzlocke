
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Pokemon Rogue - Kanto Edition</title>
  <style>
    :root{
      --ui-bg: #0b1020;
      --ui-panel: #111938;
      --ui-panel-2:#0f1631;
      --ui-accent:#00c6d7;
      --ui-accent-2:#ffd54a;
      --ui-danger:#ff6b6b;
      --ui-warning:#ff9800;
      --ui-ok:#4caf50;
      --ui-text:#e8ecff;
      --ui-muted:#9aa3c7;
      --xp-bar: #2196f3;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #060814;
      color: var(--ui-text);
      margin: 0;
      padding: 10px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    #game-container {
      width: 100%;
      max-width: 500px;
      background: linear-gradient(180deg, #0b1020 0%, #070b18 100%);
      padding: 12px;
      border-radius: 16px;
      box-shadow:
        0 0 0 2px rgba(0,198,215,.25),
        0 20px 50px rgba(0,0,0,.7);
      border: 1px solid rgba(0,198,215,.35);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    h1 {
      color: var(--ui-accent-2);
      text-align: center;
      margin: 0;
      font-size: 1.4rem;
      font-weight: 900;
      letter-spacing: .5px;
      text-shadow: 0 2px 0 #000;
      border-bottom: 2px solid rgba(255,213,74,.2);
      padding-bottom: 8px;
    }
    .hidden-title { display: none; }

    /* ======= Battle Scene ======= */
    #battle-scene{
      background-color: #333;
      border-radius: 12px;
      height: 280px;
      position: relative;
      overflow: hidden;
      border: 2px solid #000;
      box-shadow: inset 0 0 40px rgba(0,0,0,.6);
      transition: background 0.5s ease;
    }

    /* Fondos Din√°micos */
    .bg-forest { background: linear-gradient(180deg, #81c784 0%, #2e7d32 30%, #1b5e20 100%); }
    .bg-cave { background: linear-gradient(180deg, #795548 0%, #3e2723 40%, #1a100e 100%); }
    .bg-ocean { background: linear-gradient(180deg, #4fc3f7 0%, #0288d1 40%, #01579b 100%); }
    .bg-night { background: linear-gradient(180deg, #303f9f 0%, #1a237e 40%, #000000 100%); }
    .bg-volcano { background: linear-gradient(180deg, #ff8a65 0%, #d84315 40%, #3e2723 100%); }
    
    @keyframes screen-shake {
      0% { transform: translate(0, 0); }
      20% { transform: translate(-4px, 4px); }
      40% { transform: translate(4px, -4px); }
      60% { transform: translate(-4px, -4px); }
      80% { transform: translate(4px, 4px); }
      100% { transform: translate(0, 0); }
    }
    .shake-screen { animation: screen-shake 0.4s ease-out; }

    /* ZONAS DE COMBATE */
    .combatant-zone {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      z-index: 10;
    }

    #zone-opponent {
      top: 4%; 
      right: 8%;
      width: 120px;
      height: 120px;
    }

    #zone-player {
      bottom: 8%;
      left: 8%;
      width: 150px; 
      height: 150px;
      z-index: 20; 
    }

    .battle-shadow {
      width: 80%;
      height: 18px;
      background: rgba(0,0,0,0.4);
      border-radius: 50%;
      transform: scaleY(0.5);
      filter: blur(3px);
      margin-top: -8px; 
      z-index: 1;
    }

    /* Sprites */
    .sprite-container {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      position: relative;
      z-index: 5;
    }

    .sprite-img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      image-rendering: pixelated;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.4));
      transition: filter 0.2s;
    }

    @keyframes idle-anim {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .anim-idle .sprite-img { animation: idle-anim 2.5s infinite ease-in-out; }

    @keyframes attack-push-right {
      0% { transform: translateX(0); }
      30% { transform: translateX(-10px) rotate(-5deg); }
      50% { transform: translateX(40px); }
      100% { transform: translateX(0); }
    }
    @keyframes attack-push-left {
      0% { transform: translateX(0); }
      30% { transform: translateX(10px) rotate(5deg); }
      50% { transform: translateX(-40px); }
      100% { transform: translateX(0); }
    }
    .anim-attack-player .sprite-img { animation: attack-push-right 0.3s ease-in-out; }
    .anim-attack-opponent .sprite-img { animation: attack-push-left 0.3s ease-in-out; }

    @keyframes damage-blink {
      0%, 100% { opacity: 1; filter: brightness(1) sepia(0) saturate(1); }
      20% { opacity: 0.2; filter: brightness(10) sepia(1) hue-rotate(-50deg); }
      40% { opacity: 1; filter: brightness(1); }
      60% { opacity: 0.2; filter: brightness(10) sepia(1) hue-rotate(-50deg); }
      80% { opacity: 1; filter: brightness(1); }
    }
    .anim-damage .sprite-img { animation: damage-blink 0.6s linear; }

    /* UI Stats Boxes */
    .stats-box {
      position: absolute;
      background: rgba(17, 25, 56, 0.95);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 6px;
      padding: 4px 8px;
      width: 120px;
      z-index: 30;
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      pointer-events: none;
    }
    #opponent-box { left: 12px; top: 12px; }
    #player-box { right: 12px; bottom: 30px; }

    .poke-name { 
      font-weight: 800; font-size: 0.8rem; margin-bottom: 2px; 
      display: flex; justify-content: space-between; align-items:center;
    }
    .poke-lvl { color: var(--ui-accent-2); font-size: 0.8rem; }
    
    .hp-container {
      background: #222;
      height: 6px;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.2);
      position: relative;
    }
    .hp-fill {
      height: 100%;
      background: var(--ui-ok);
      width: 100%;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s;
    }
    .hp-text { font-size: 0.7rem; text-align: right; margin-top: 1px; font-weight: bold; text-shadow: 0 1px 1px black; }
    
    .xp-container {
      margin-top: 2px;
      background: #111;
      height: 3px;
      border-radius: 2px;
      overflow: hidden;
    }
    .xp-fill {
      height: 100%;
      background: var(--xp-bar);
      width: 0%;
      transition: width 0.4s;
    }

    /* Status Tags */
    .status-tag {
      font-size: 0.65rem;
      padding: 1px 3px;
      border-radius: 3px;
      margin-right: 4px;
      font-weight: bold;
      color: #fff;
      display: inline-block;
    }
    .status-BRN { background: #ff5722; }
    .status-PSN { background: #9c27b0; }
    .status-PAR { background: #ffeb3b; color: #000; }
    .status-SLP { background: #90a4ae; }
    .status-FRZ { background: #03a9f4; }

    /* PROYECTILES Y VFX */
    .projectile {
      position: absolute;
      width: 32px;
      height: 32px;
      z-index: 25;
      pointer-events: none;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      transition: top 0.4s linear, left 0.4s linear;
    }
    .proj-fire { background: radial-gradient(circle, #ffeb3b 20%, #f44336 70%); border-radius: 50%; box-shadow: 0 0 10px orange; }
    .proj-water { background: radial-gradient(circle at 30% 30%, #fff, #2196f3); border-radius: 50% 50% 50% 0; transform: rotate(-45deg); box-shadow: 0 0 10px #03a9f4; }
    .proj-grass { background-color: #4caf50; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
    .proj-electric { background: #ffeb3b; clip-path: polygon(25% 0%, 100% 0%, 75% 100%, 0% 100%); box-shadow: 0 0 15px yellow; }
    .proj-rock { background: #795548; border-radius: 50%; border: 2px solid #3e2723; }
    .proj-normal { background: #fff; border-radius: 50%; opacity: 0.8; }
    .proj-ghost { background: #9c27b0; border-radius: 50%; box-shadow: 0 0 15px #e1bee7; opacity: 0.7; }
    
    .vfx-particle {
      position: absolute;
      pointer-events: none;
      font-size: 20px;
      z-index: 26;
      animation: impact-explode 0.6s ease-out forwards;
    }
    @keyframes impact-explode {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
      100% { transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(var(--rot)); opacity: 0; }
    }

    /* ======= Logs & Controls ======= */
    #combat-log {
      height: 60px;
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--ui-accent);
      padding: 8px;
      overflow-y: auto;
      border-radius: 8px;
      font-size: 0.85rem;
      line-height: 1.3;
      color: #fff;
    }

    #controls-area {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }

    button {
      background: var(--ui-panel-2);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--ui-text);
      padding: 10px 4px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.1s;
      text-transform: capitalize;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }
    button:active:not(:disabled) { transform: translateY(2px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

    .btn-move { background: #232944; border-bottom: 3px solid rgba(0,0,0,0.3); }
    .btn-move:hover:not(:disabled) { filter: brightness(1.2); }
    
    .type-Fuego { background: #d84315; color: #fff; }
    .type-Agua { background: #1565c0; color: #fff; }
    .type-Planta { background: #2e7d32; color: #fff; }
    .type-El√©ctrico { background: #f9a825; color: #000; }
    .type-Normal { background: #78909c; color: #fff; }
    .type-Volador { background: #7e57c2; color: #fff; }
    .type-Bicho { background: #827717; color: #fff; }
    .type-Veneno { background: #6a1b9a; color: #fff; }
    .type-Tierra { background: #795548; color: #fff; }
    .type-Roca { background: #5d4037; color: #fff; }
    .type-Lucha { background: #b71c1c; color: #fff; }
    .type-Ps√≠quico { background: #c2185b; color: #fff; }
    .type-Fantasma { background: #4527a0; color: #fff; }
    .type-Hielo { background: #00acc1; color: #fff; }
    .type-Drag√≥n { background: #311b92; color: #fff; }
    /* Nuevos en 2¬™ Generaci√≥n */
    .type-Acero { background: #607d8b; color: #fff; }
    .type-Siniestro { background: #212121; color: #fff; }
    
    .btn-action { background: #37474f; color: #eceff1; }
    .btn-capture { background: #c62828; }
    .btn-potion { background: #2e7d32; }
    .btn-switch { background: #f57f17; color: black; }
    
    #start-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 5px;
    }
    #btn-normal { background: linear-gradient(135deg, var(--ui-accent-2), var(--ui-warning)); color: #000; padding: 14px; font-size:1.1rem; border:none; }
    #btn-nuzlocke { background: linear-gradient(135deg, #7b1fa2, #4a148c); color: #fff; padding: 14px; font-size:1.1rem; border:none; }

    #team-bar {
      display: flex;
      justify-content: space-between;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
    }

    /* Generic Modal Overlay */
    .modal-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(11, 16, 32, 0.95);
      z-index: 50;
      display: none;
      flex-direction: column;
      padding: 10px;
      box-sizing: border-box;
      justify-content: center;
    }
    
    .modal-title { text-align:center; margin:0 0 10px 0; color: var(--ui-accent); }
    .modal-list { flex:1; overflow-y:auto; margin-bottom: 10px; }
    
    .modal-card {
      background: var(--ui-panel);
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .modal-card:hover { border-color: var(--ui-accent); }
    .modal-card.selected { border-color: var(--ui-accent-2); background: #222; }
    .modal-card.fainted { opacity: 0.6; filter: grayscale(1); cursor: not-allowed; }
    
    .mode-badge {
      position: absolute;
      top: 5px; left: 5px;
      font-size: 0.7rem;
      background: #333;
      padding: 2px 6px;
      border-radius: 4px;
      opacity: 0.7;
    }
  </style>
<link rel="stylesheet" href="/index.css">
</head>

<body onload="initGame()">

  <div id="game-container">
    <div id="mode-display" class="mode-badge"></div>
    <h1 id="game-title">‚öîÔ∏è PokeRogue Kanto üí•</h1>

    <div id="battle-scene" class="bg-forest">
      <div id="vfx-layer" style="position:absolute; inset:0; pointer-events:none; z-index:40;"></div>

      <div class="stats-box" id="opponent-box"></div>
      
      <!-- Zona Enemigo -->
      <div class="combatant-zone" id="zone-opponent">
        <div class="sprite-container anim-idle" id="opponent-sprite-slot"></div>
        <div class="battle-shadow"></div>
      </div>

      <!-- Zona Jugador -->
      <div class="combatant-zone" id="zone-player">
        <div class="sprite-container anim-idle" id="player-sprite-slot"></div>
        <div class="battle-shadow"></div>
      </div>

      <div class="stats-box" id="player-box"></div>
    </div>

    <div id="team-bar">
      <span>üé± x<b id="balls-val">0</b></span>
      <span>üíä x<b id="pots-val">0</b></span>
      <span>üèÜ Racha: <b id="streak-val">0</b></span>
    </div>

    <div id="combat-log">Bienvenido a Kanto Rogue.</div>

    <div id="controls-area">
      <div id="move-controls" class="grid-2"></div>
      
      <div id="utility-controls" class="grid-3">
        <button class="btn-action btn-potion" onclick="usePotion()" id="btn-potion">Poci√≥n</button>
        <button class="btn-action btn-capture" onclick="attemptCapture()" id="btn-capture">Capturar</button>
        <button class="btn-action btn-switch" onclick="openSwitchMenu()" id="btn-switch">Cambiar</button>
      </div>

      <div class="grid-2">
        <button class="btn-action" onclick="saveGame()">üíæ Guardar</button>
        <button class="btn-action" onclick="loadGame()" id="btn-load" disabled>üìÇ Cargar</button>
      </div>
    </div>

    <div id="start-buttons">
      <button id="btn-normal" onclick="startGame('normal')">Modo Normal</button>
      <button id="btn-nuzlocke" onclick="startGame('nuzlocke')">‚ò†Ô∏è Modo Nuzlocke</button>
    </div>

    <!-- SWITCH MENU -->
    <div id="switch-overlay" class="modal-overlay">
      <h3 class="modal-title">Elige un Pok√©mon</h3>
      <div id="switch-list" class="modal-list"></div>
      <button class="btn-action" onclick="closeSwitchMenu()">Cancelar</button>
    </div>

    <!-- MOVE LEARNING MENU -->
    <div id="move-overlay" class="modal-overlay">
      <h3 class="modal-title">¬°L√≠mite de movimientos!</h3>
      <p style="text-align:center; font-size:0.9rem; margin-bottom:10px;">Elige un movimiento para olvidar:</p>
      <div id="move-list" class="modal-list"></div>
      <button class="btn-action" id="btn-cancel-learn">No aprender</button>
    </div>

    <!-- FULL PARTY MENU -->
    <div id="party-full-overlay" class="modal-overlay">
      <h3 class="modal-title">¬°Equipo Completo!</h3>
      <p style="text-align:center; font-size:0.9rem; margin-bottom:10px;">Selecciona un Pok√©mon para <b>liberar</b> y hacer sitio al nuevo, o libera al capturado.</p>
      <div id="party-full-list" class="modal-list"></div>
      <button class="btn-action btn-capture" id="btn-release-new">Liberar al Nuevo</button>
    </div>
  </div>

<script>
/* =========================================================
   DATABASE & CONFIG
========================================================= */
const CONSTANTS = {
  START_BALLS: 6,
  START_POTS: 6,
  MAX_BALLS: 100,
  MAX_POTS: 50,
  HEAL_STREAK: 3,
  XP_MULT: 4.5, 
  SHINY_CHANCE: 0.005,
  MAX_TEAM: 6
};

const SLUG_MAP = {
  "Nidoran-F": "nidoran-f", "Nidoran-M": "nidoran-m", "Mr. Mime": "mr-mime", "Farfetch'd": "farfetchd"
};

const MOVES = {
  // --- NORMAL ---
  'Tackle': { nombre: 'Placaje', poder: 40, tipo: 'Normal', cat: 'Fis' },
  'Scratch': { nombre: 'Ara√±azo', poder: 40, tipo: 'Normal', cat: 'Fis' },
  'Quick Attack': { nombre: 'Ataque R√°pido', poder: 40, tipo: 'Normal', cat: 'Fis' },
  'Cut': { nombre: 'Corte', poder: 50, tipo: 'Normal', cat: 'Fis' },
  'Headbutt': { nombre: 'Golpe Cabeza', poder: 70, tipo: 'Normal', cat: 'Fis', effect: 'FLI', chance: 0.3 },
  'Body Slam': { nombre: 'Golpe Cuerpo', poder: 85, tipo: 'Normal', cat: 'Fis', effect: 'PAR', chance: 0.3 },
  'Slash': { nombre: 'Cuchillada', poder: 70, tipo: 'Normal', cat: 'Fis' }, // Alta prob critico
  'Double-Edge': { nombre: 'Doble Filo', poder: 120, tipo: 'Normal', cat: 'Fis' }, // Tiene recoil
  'Hyper Beam': { nombre: 'Hiperrayo', poder: 150, tipo: 'Normal', cat: 'Esp' },
  'Tri Attack': { nombre: 'Triataque', poder: 80, tipo: 'Normal', cat: 'Esp', effect: 'PAR|BRN|FRZ', chance: 0.2 },
  'Extreme Speed': { nombre: 'Velocidad Extrema', poder: 80, tipo: 'Normal', cat: 'Fis' },

  // --- FUEGO ---
  'Ember': { nombre: 'Ascuas', poder: 40, tipo: 'Fuego', cat: 'Esp', effect: 'BRN', chance: 0.1 },
  'Flamethrower': { nombre: 'Lanzallamas', poder: 90, tipo: 'Fuego', cat: 'Esp', effect: 'BRN', chance: 0.1 },
  'Fire Punch': { nombre: 'Pu√±o Fuego', poder: 75, tipo: 'Fuego', cat: 'Fis', effect: 'BRN', chance: 0.1 },
  'Fire Blast': { nombre: 'Llamarada', poder: 110, tipo: 'Fuego', cat: 'Esp', effect: 'BRN', chance: 0.1 },
  'Flame Wheel': { nombre: 'Rueda Fuego', poder: 60, tipo: 'Fuego', cat: 'Fis', effect: 'BRN', chance: 0.1 },
  'Sacred Fire': { nombre: 'Fuego Sagrado', poder: 100, tipo: 'Fuego', cat: 'Fis', effect: 'BRN', chance: 0.5 },

  // --- AGUA ---
  'Water Gun': { nombre: 'Pistola Agua', poder: 40, tipo: 'Agua', cat: 'Esp' },
  'Surf': { nombre: 'Surf', poder: 90, tipo: 'Agua', cat: 'Esp' },
  'Bubble Beam': { nombre: 'Rayo Burbuja', poder: 65, tipo: 'Agua', cat: 'Esp', effect: 'SPD_DOWN', chance: 0.1 },
  'Hydro Pump': { nombre: 'Hidrobomba', poder: 110, tipo: 'Agua', cat: 'Esp' },
  'Waterfall': { nombre: 'Cascada', poder: 80, tipo: 'Agua', cat: 'Fis', effect: 'FLI', chance: 0.2 },

  // --- PLANTA ---
  'Vine Whip': { nombre: 'L√°tigo Cepa', poder: 45, tipo: 'Planta', cat: 'Fis' },
  'Razor Leaf': { nombre: 'Hoja Afilada', poder: 55, tipo: 'Planta', cat: 'Fis' }, // Alta prob critico
  'Solar Beam': { nombre: 'Rayo Solar', poder: 120, tipo: 'Planta', cat: 'Esp' }, // 2 turnos
  'Giga Drain': { nombre: 'Gigadrenado', poder: 75, tipo: 'Planta', cat: 'Esp' }, // Roba vida
  'Petal Dance': { nombre: 'Danza P√©talo', poder: 120, tipo: 'Planta', cat: 'Esp' },

  // --- EL√âCTRICO ---
  'Thunder Shock': { nombre: 'Impactrueno', poder: 40, tipo: 'El√©ctrico', cat: 'Esp', effect: 'PAR', chance: 0.1 },
  'Thunderbolt': { nombre: 'Rayo', poder: 90, tipo: 'El√©ctrico', cat: 'Esp', effect: 'PAR', chance: 0.1 },
  'Thunder Punch': { nombre: 'Pu√±o Trueno', poder: 75, tipo: 'El√©ctrico', cat: 'Fis', effect: 'PAR', chance: 0.1 },
  'Thunder': { nombre: 'Trueno', poder: 110, tipo: 'El√©ctrico', cat: 'Esp', effect: 'PAR', chance: 0.3 },
  'Spark': { nombre: 'Chispa', poder: 65, tipo: 'El√©ctrico', cat: 'Fis', effect: 'PAR', chance: 0.3 },
  'Zap Cannon': { nombre: 'Electroca√±√≥n', poder: 120, tipo: 'El√©ctrico', cat: 'Esp', effect: 'PAR', chance: 1.0 },

  // --- HIELO ---
  'Ice Beam': { nombre: 'Rayo Hielo', poder: 90, tipo: 'Hielo', cat: 'Esp', effect: 'FRZ', chance: 0.1 },
  'Ice Punch': { nombre: 'Pu√±o Hielo', poder: 75, tipo: 'Hielo', cat: 'Fis', effect: 'FRZ', chance: 0.1 },
  'Blizzard': { nombre: 'Ventisca', poder: 110, tipo: 'Hielo', cat: 'Esp', effect: 'FRZ', chance: 0.1 },
  'Icy Wind': { nombre: 'Viento Hielo', poder: 55, tipo: 'Hielo', cat: 'Esp', effect: 'SPD_DOWN', chance: 1.0 },

  // --- LUCHA ---
  'Karate Chop': { nombre: 'Golpe Karate', poder: 50, tipo: 'Lucha', cat: 'Fis' }, // En Gen2 cambia a Lucha
  'Mach Punch': { nombre: 'Ultrapu√±o', poder: 40, tipo: 'Lucha', cat: 'Fis' },
  'Cross Chop': { nombre: 'Tajo Cruzado', poder: 100, tipo: 'Lucha', cat: 'Fis' },
  'Dynamic Punch': { nombre: 'Pu√±o Din√°mico', poder: 100, tipo: 'Lucha', cat: 'Fis', effect: 'CON', chance: 1.0 },
  'Reversal': { nombre: 'Inversi√≥n', poder: 0, tipo: 'Lucha', cat: 'Fis' }, // Variable
  
  // --- VENENO ---
  'Poison Sting': { nombre: 'Picotazo Ven', poder: 15, tipo: 'Veneno', cat: 'Fis', effect: 'PSN', chance: 0.3 },
  'Sludge Bomb': { nombre: 'Bomba Lodo', poder: 90, tipo: 'Veneno', cat: 'Esp', effect: 'PSN', chance: 0.3 },
  
  // --- TIERRA ---
  'Earthquake': { nombre: 'Terremoto', poder: 100, tipo: 'Tierra', cat: 'Fis' },
  'Dig': { nombre: 'Excavar', poder: 80, tipo: 'Tierra', cat: 'Fis' }, // 2 turnos
  'Mud-Slap': { nombre: 'Bofet√≥n Lodo', poder: 20, tipo: 'Tierra', cat: 'Esp', effect: 'ACC_DOWN', chance: 1.0 },
  'Bonemerang': { nombre: 'Huesomerang', poder: 50, tipo: 'Tierra', cat: 'Fis' }, // Golpea 2 veces
  
  // --- VOLADOR ---
  'Wing Attack': { nombre: 'Ataque Ala', poder: 60, tipo: 'Volador', cat: 'Fis' },
  'Peck': { nombre: 'Picotazo', poder: 35, tipo: 'Volador', cat: 'Fis' },
  'Fly': { nombre: 'Vuelo', poder: 90, tipo: 'Volador', cat: 'Fis' }, // 2 turnos
  'Drill Peck': { nombre: 'Pico Taladro', poder: 80, tipo: 'Volador', cat: 'Fis' },
  'Aeroblast': { nombre: 'Aerochorro', poder: 100, tipo: 'Volador', cat: 'Esp' },

  // --- PS√çQUICO ---
  'Psychic': { nombre: 'Ps√≠quico', poder: 90, tipo: 'Ps√≠quico', cat: 'Esp', effect: 'SPDEF_DOWN', chance: 0.1 },
  'Confusion': { nombre: 'Confusi√≥n', poder: 50, tipo: 'Ps√≠quico', cat: 'Esp', effect: 'CON', chance: 0.1 },
  'Psybeam': { nombre: 'Psicorrayo', poder: 65, tipo: 'Ps√≠quico', cat: 'Esp', effect: 'CON', chance: 0.1 },
  'Dream Eater': { nombre: 'Comesue√±os', poder: 100, tipo: 'Ps√≠quico', cat: 'Esp' }, // Solo dormidos

  // --- BICHO ---
  'Megahorn': { nombre: 'Megacuerno', poder: 120, tipo: 'Bicho', cat: 'Fis' },
  'Pin Missile': { nombre: 'Pin Misil', poder: 25, tipo: 'Bicho', cat: 'Fis' }, // 2-5 golpes
  'Fury Cutter': { nombre: 'Corte Furia', poder: 40, tipo: 'Bicho', cat: 'Fis' }, // Sube poder consecutivamente

  // --- ROCA ---
  'Rock Throw': { nombre: 'Lanzarrocas', poder: 50, tipo: 'Roca', cat: 'Fis' },
  'Rock Slide': { nombre: 'Avalancha', poder: 75, tipo: 'Roca', cat: 'Fis', effect: 'FLI', chance: 0.3 },
  'Ancient Power': { nombre: 'Poder Pasado', poder: 60, tipo: 'Roca', cat: 'Esp', effect: 'ALL_UP', chance: 0.1 },
  'Rollout': { nombre: 'Desenrollar', poder: 30, tipo: 'Roca', cat: 'Fis' }, // Sube poder

  // --- FANTASMA ---
  'Lick': { nombre: 'Leng√ºetazo', poder: 30, tipo: 'Fantasma', cat: 'Fis', effect: 'PAR', chance: 0.3 },
  'Shadow Ball': { nombre: 'Bola Sombra', poder: 80, tipo: 'Fantasma', cat: 'Esp', effect: 'SPDEF_DOWN', chance: 0.2 },
  
  // --- DRAG√ìN ---
  'Dragon Rage': { nombre: 'Furia Drag√≥n', poder: 0, tipo: 'Drag√≥n', cat: 'Esp' }, // Da√±o fijo 40
  'Dragon Breath': { nombre: 'Dragoaliento', poder: 60, tipo: 'Drag√≥n', cat: 'Esp', effect: 'PAR', chance: 0.3 },
  'Outrage': { nombre: 'Enfado', poder: 120, tipo: 'Drag√≥n', cat: 'Fis', effect: 'CON', chance: 1.0 }, // Self confusion

  // --- ACERO (NUEVO GEN 2) ---
  'Steel Wing': { nombre: 'Ala de Acero', poder: 70, tipo: 'Acero', cat: 'Fis', effect: 'DEF_UP', chance: 0.1 },
  'Iron Tail': { nombre: 'Cola F√©rrea', poder: 100, tipo: 'Acero', cat: 'Fis', effect: 'DEF_DOWN', chance: 0.3 },
  'Metal Claw': { nombre: 'Garra Metal', poder: 50, tipo: 'Acero', cat: 'Fis', effect: 'ATK_UP', chance: 0.1 },

  // --- SINIESTRO (NUEVO GEN 2) ---
  'Bite': { nombre: 'Mordisco', poder: 60, tipo: 'Siniestro', cat: 'Fis', effect: 'FLI', chance: 0.3 }, // Cambiado a Siniestro
  'Crunch': { nombre: 'Triturar', poder: 80, tipo: 'Siniestro', cat: 'Fis', effect: 'DEF_DOWN', chance: 0.2 },
  'Faint Attack': { nombre: 'Finta', poder: 60, tipo: 'Siniestro', cat: 'Fis' }, // Infalible
  'Thief': { nombre: 'Ladr√≥n', poder: 60, tipo: 'Siniestro', cat: 'Fis' },
  'Pursuit': { nombre: 'Persecuci√≥n', poder: 40, tipo: 'Siniestro', cat: 'Fis' }
};

const EVOLUTIONS = {
  // --- KANTO (GEN 1) ---
  'Bulbasaur': { 16: 'Ivysaur', 10: 'Vine Whip', 25: 'Razor Leaf' },
  'Ivysaur': { 32: 'Venusaur', 22: 'Razor Leaf' },
  'Venusaur': { 45: 'Solar Beam' },
  
  'Charmander': { 16: 'Charmeleon', 10: 'Ember', 25: 'Flamethrower' },
  'Charmeleon': { 36: 'Charizard', 30: 'Flamethrower' },
  'Charizard': { 40: 'Wing Attack', 50: 'Fire Blast' },

  'Squirtle': { 16: 'Wartortle', 10: 'Water Gun', 25: 'Bite' },
  'Wartortle': { 36: 'Blastoise', 30: 'Ice Beam' }, // Simplificado
  'Blastoise': { 45: 'Hydro Pump' },

  'Pidgey': { 18: 'Pidgeotto', 12: 'Quick Attack', 20: 'Wing Attack' },
  'Pidgeotto': { 36: 'Pidgeot', 25: 'Wing Attack' },
  'Pidgeot': { 40: 'Fly' },

  'Rattata': { 20: 'Raticate', 10: 'Quick Attack', 15: 'Hyper Fang' },
  'Pikachu': { 22: 'Raichu', 10: 'Thunder Shock', 26: 'Thunderbolt' },
  
  'Zubat': { 22: 'Golbat', 15: 'Bite' },
  'Golbat': { 35: 'Crobat', 25: 'Wing Attack' }, // Evoluci√≥n Cross-Gen

  'Oddish': { 21: 'Gloom', 15: 'Poison Powder' },
  'Gloom': { 30: 'Vileplume' }, // Piedra Hoja simplificada

  'Mankey': { 28: 'Primeape', 15: 'Karate Chop' },
  'Poliwag': { 25: 'Poliwhirl', 15: 'Water Gun' },
  'Poliwhirl': { 35: 'Poliwrath', 30: 'Body Slam' },

  'Abra': { 16: 'Kadabra' },
  'Kadabra': { 36: 'Alakazam', 20: 'Psychic', 25: 'Recover' },
  
  'Machop': { 28: 'Machoke', 20: 'Karate Chop' },
  'Machoke': { 40: 'Machamp', 35: 'Cross Chop' },

  'Geodude': { 25: 'Graveler', 15: 'Rock Throw' },
  'Graveler': { 40: 'Golem', 30: 'Earthquake' },

  'Gastly': { 25: 'Haunter', 15: 'Lick' },
  'Haunter': { 40: 'Gengar', 25: 'Shadow Ball' },

  'Onix': { 40: 'Steelix', 20: 'Rock Throw', 30: 'Iron Tail' }, // Evoluci√≥n Cross-Gen

  'Eevee': { 25: 'Vaporeon', 26: 'Jolteon', 27: 'Flareon', 28: 'Espeon', 29: 'Umbreon', 10: 'Quick Attack' }, // Niveles arbitrarios para diferenciar

  'Scyther': { 40: 'Scizor', 20: 'Wing Attack', 30: 'Slash' }, // Evoluci√≥n Cross-Gen
  'Magikarp': { 20: 'Gyarados', 15: 'Tackle' },
  'Gyarados': { 25: 'Bite', 35: 'Hydro Pump' },

  'Dratini': { 30: 'Dragonair', 20: 'Dragon Rage' },
  'Dragonair': { 55: 'Dragonite', 40: 'Dragon Breath' },
  'Dragonite': { 60: 'Outrage' },

  // --- JOHTO (GEN 2) ---
  'Chikorita': { 16: 'Bayleef', 10: 'Razor Leaf', 15: 'Poison Powder' },
  'Bayleef': { 32: 'Meganium', 20: 'Reflect', 30: 'Body Slam' },
  'Meganium': { 40: 'Solar Beam' },

  'Cyndaquil': { 14: 'Quilava', 12: 'Ember', 20: 'Quick Attack' },
  'Quilava': { 36: 'Typhlosion', 30: 'Flame Wheel' },
  'Typhlosion': { 45: 'Flamethrower' },

  'Totodile': { 18: 'Croconaw', 13: 'Water Gun', 20: 'Bite' },
  'Croconaw': { 30: 'Feraligatr', 25: 'Ice Fang' },
  'Feraligatr': { 40: 'Hydro Pump', 45: 'Slash' },

  'Sentret': { 15: 'Furret', 10: 'Quick Attack' },
  'Hoothoot': { 20: 'Noctowl', 15: 'Peck' },
  'Ledyba': { 18: 'Ledian', 12: 'Comet Punch' },
  'Spinarak': { 22: 'Ariados', 12: 'Poison Sting' },
  
  'Mareep': { 15: 'Flaaffy', 10: 'Thunder Shock' },
  'Flaaffy': { 30: 'Ampharos', 20: 'Thunder Punch' },
  'Ampharos': { 40: 'Thunder' },

  'Marill': { 18: 'Azumarill', 10: 'Water Gun', 15: 'Bubble Beam' },
  'Wooper': { 20: 'Quagsire', 15: 'Water Gun' },
  'Quagsire': { 25: 'Earthquake' },

  'Snubbull': { 23: 'Granbull', 15: 'Bite' },
  'Teddiursa': { 30: 'Ursaring', 15: 'Scratch', 25: 'Faint Attack' },
  
  'Houndour': { 24: 'Houndoom', 15: 'Ember', 20: 'Bite' },
  'Houndoom': { 35: 'Crunch', 45: 'Flamethrower' },

  'Phanpy': { 25: 'Donphan', 15: 'Rollout' },
  'Donphan': { 35: 'Earthquake' },

  'Larvitar': { 30: 'Pupitar', 15: 'Rock Slide', 22: 'Bite' },
  'Pupitar': { 55: 'Tyranitar', 40: 'Crunch' },
  'Tyranitar': { 60: 'Earthquake', 65: 'Hyper Beam' }
};

const POKEMON_PART_1 = {
  'Bulbasaur': { hp: 45, atk: 49, def: 49, type: ['Planta', 'Veneno'], moves: ['Tackle', 'Vine Whip'] },
  'Ivysaur': { hp: 60, atk: 62, def: 63, type: ['Planta', 'Veneno'], moves: ['Vine Whip', 'Razor Leaf'] },
  'Venusaur': { hp: 80, atk: 82, def: 83, type: ['Planta', 'Veneno'], moves: ['Razor Leaf', 'Solar Beam'] },
  'Charmander': { hp: 39, atk: 52, def: 43, type: ['Fuego'], moves: ['Scratch', 'Ember'] },
  'Charmeleon': { hp: 58, atk: 64, def: 58, type: ['Fuego'], moves: ['Scratch', 'Flamethrower'] },
  'Charizard': { hp: 78, atk: 84, def: 78, type: ['Fuego', 'Volador'], moves: ['Flamethrower', 'Wing Attack'] },
  'Squirtle': { hp: 44, atk: 48, def: 65, type: ['Agua'], moves: ['Tackle', 'Water Gun'] },
  'Wartortle': { hp: 59, atk: 63, def: 80, type: ['Agua'], moves: ['Water Gun', 'Bite'] },
  'Blastoise': { hp: 79, atk: 83, def: 100, type: ['Agua'], moves: ['Surf', 'Hydro Pump'] },
  'Caterpie': { hp: 45, atk: 30, def: 35, type: ['Bicho'], moves: ['Tackle'] },
  'Metapod': { hp: 50, atk: 20, def: 55, type: ['Bicho'], moves: ['Harden'] },
  'Butterfree': { hp: 60, atk: 45, def: 50, type: ['Bicho', 'Volador'], moves: ['Confusion', 'Gust'] },
  'Weedle': { hp: 40, atk: 35, def: 30, type: ['Bicho', 'Veneno'], moves: ['Poison Sting'] },
  'Kakuna': { hp: 45, atk: 25, def: 50, type: ['Bicho', 'Veneno'], moves: ['Harden'] },
  'Beedrill': { hp: 65, atk: 80, def: 40, type: ['Bicho', 'Veneno'], moves: ['Twineedle', 'Pin Missile'] },
  'Pidgey': { hp: 40, atk: 45, def: 40, type: ['Normal', 'Volador'], moves: ['Tackle', 'Gust'] },
  'Pidgeotto': { hp: 63, atk: 60, def: 55, type: ['Normal', 'Volador'], moves: ['Quick Attack', 'Wing Attack'] },
  'Pidgeot': { hp: 83, atk: 80, def: 75, type: ['Normal', 'Volador'], moves: ['Wing Attack', 'Fly'] },
  'Rattata': { hp: 30, atk: 56, def: 35, type: ['Normal'], moves: ['Tackle', 'Quick Attack'] },
  'Raticate': { hp: 55, atk: 81, def: 60, type: ['Normal'], moves: ['Hyper Fang', 'Quick Attack'] },
  'Spearow': { hp: 40, atk: 60, def: 30, type: ['Normal', 'Volador'], moves: ['Peck', 'Drill Peck'] },
  'Fearow': { hp: 65, atk: 90, def: 65, type: ['Normal', 'Volador'], moves: ['Drill Peck', 'Fly'] },
  'Ekans': { hp: 35, atk: 60, def: 44, type: ['Veneno'], moves: ['Poison Sting', 'Bite'] },
  'Arbok': { hp: 60, atk: 85, def: 69, type: ['Veneno'], moves: ['Bite', 'Acid'] },
  'Pikachu': { hp: 35, atk: 55, def: 40, type: ['El√©ctrico'], moves: ['Thunder Shock', 'Quick Attack'] },
  'Raichu': { hp: 60, atk: 90, def: 55, type: ['El√©ctrico'], moves: ['Thunderbolt', 'Thunder'] },
  'Sandshrew': { hp: 50, atk: 75, def: 85, type: ['Tierra'], moves: ['Scratch', 'Sand Attack'] },
  'Sandslash': { hp: 75, atk: 100, def: 110, type: ['Tierra'], moves: ['Slash', 'Earthquake'] },
  'Nidoran F': { hp: 55, atk: 47, def: 52, type: ['Veneno'], moves: ['Scratch', 'Poison Sting'] },
  'Nidorina': { hp: 70, atk: 62, def: 67, type: ['Veneno'], moves: ['Bite', 'Double Kick'] },
  'Nidoqueen': { hp: 90, atk: 92, def: 87, type: ['Veneno', 'Tierra'], moves: ['Body Slam', 'Earthquake'] },
  'Nidoran M': { hp: 46, atk: 57, def: 40, type: ['Veneno'], moves: ['Peck', 'Poison Sting'] },
  'Nidorino': { hp: 61, atk: 72, def: 57, type: ['Veneno'], moves: ['Horn Attack', 'Double Kick'] },
  'Nidoking': { hp: 81, atk: 102, def: 77, type: ['Veneno', 'Tierra'], moves: ['Thrash', 'Earthquake'] },
  'Clefairy': { hp: 70, atk: 45, def: 48, type: ['Normal'], moves: ['Pound', 'Sing'] },
  'Clefable': { hp: 95, atk: 70, def: 73, type: ['Normal'], moves: ['Metronome', 'Moonlight'] },
  'Vulpix': { hp: 38, atk: 41, def: 40, type: ['Fuego'], moves: ['Ember', 'Quick Attack'] },
  'Ninetales': { hp: 73, atk: 76, def: 75, type: ['Fuego'], moves: ['Flamethrower', 'Confuse Ray'] },
  'Jigglypuff': { hp: 115, atk: 45, def: 20, type: ['Normal'], moves: ['Pound', 'Sing'] },
  'Wigglytuff': { hp: 140, atk: 70, def: 45, type: ['Normal'], moves: ['Double-Edge', 'Sing'] },
  'Zubat': { hp: 40, atk: 45, def: 35, type: ['Veneno', 'Volador'], moves: ['Leech Life', 'Supersonic'] },
  'Golbat': { hp: 75, atk: 80, def: 70, type: ['Veneno', 'Volador'], moves: ['Wing Attack', 'Bite'] },
  'Oddish': { hp: 45, atk: 50, def: 55, type: ['Planta', 'Veneno'], moves: ['Absorb', 'Acid'] },
  'Gloom': { hp: 60, atk: 65, def: 70, type: ['Planta', 'Veneno'], moves: ['Acid', 'Petal Dance'] },
  'Vileplume': { hp: 75, atk: 80, def: 85, type: ['Planta', 'Veneno'], moves: ['Petal Dance', 'Solar Beam'] },
  'Paras': { hp: 35, atk: 70, def: 55, type: ['Bicho', 'Planta'], moves: ['Scratch', 'Stun Spore'] },
  'Parasect': { hp: 60, atk: 95, def: 80, type: ['Bicho', 'Planta'], moves: ['Slash', 'Spore'] },
  'Venonat': { hp: 60, atk: 55, def: 50, type: ['Bicho', 'Veneno'], moves: ['Tackle', 'Confusion'] },
  'Venomoth': { hp: 70, atk: 65, def: 60, type: ['Bicho', 'Veneno'], moves: ['Psybeam', 'Gust'] },
  'Diglett': { hp: 10, atk: 55, def: 25, type: ['Tierra'], moves: ['Scratch', 'Dig'] },
  'Dugtrio': { hp: 35, atk: 80, def: 50, type: ['Tierra'], moves: ['Dig', 'Earthquake'] },
  'Meowth': { hp: 40, atk: 45, def: 35, type: ['Normal'], moves: ['Scratch', 'Bite'] },
  'Persian': { hp: 65, atk: 70, def: 60, type: ['Normal'], moves: ['Slash', 'Bite'] },
  'Psyduck': { hp: 50, atk: 52, def: 48, type: ['Agua'], moves: ['Scratch', 'Confusion'] },
  'Golduck': { hp: 80, atk: 82, def: 78, type: ['Agua'], moves: ['Surf', 'Psychic'] },
  'Mankey': { hp: 40, atk: 80, def: 35, type: ['Lucha'], moves: ['Scratch', 'Karate Chop'] },
  'Primeape': { hp: 65, atk: 105, def: 60, type: ['Lucha'], moves: ['Cross Chop', 'Thrash'] },
  'Growlithe': { hp: 55, atk: 70, def: 45, type: ['Fuego'], moves: ['Bite', 'Ember'] },
  'Arcanine': { hp: 90, atk: 110, def: 80, type: ['Fuego'], moves: ['Flamethrower', 'Extreme Speed'] },
  'Poliwag': { hp: 40, atk: 50, def: 40, type: ['Agua'], moves: ['Water Gun', 'Hypnosis'] },
  'Poliwhirl': { hp: 65, atk: 65, def: 65, type: ['Agua'], moves: ['Bubble Beam', 'Body Slam'] },
  'Poliwrath': { hp: 90, atk: 85, def: 95, type: ['Agua', 'Lucha'], moves: ['Hydro Pump', 'Dynamic Punch'] },
  'Abra': { hp: 25, atk: 20, def: 15, type: ['Ps√≠quico'], moves: ['Teleport'] },
  'Kadabra': { hp: 40, atk: 35, def: 30, type: ['Ps√≠quico'], moves: ['Psychic', 'Confusion'] },
  'Alakazam': { hp: 55, atk: 50, def: 45, type: ['Ps√≠quico'], moves: ['Psychic', 'Recover'] },
  'Machop': { hp: 70, atk: 80, def: 50, type: ['Lucha'], moves: ['Karate Chop', 'Low Kick'] },
  'Machoke': { hp: 80, atk: 100, def: 70, type: ['Lucha'], moves: ['Seismic Toss', 'Cross Chop'] },
  'Machamp': { hp: 90, atk: 130, def: 80, type: ['Lucha'], moves: ['Cross Chop', 'Earthquake'] },
  'Bellsprout': { hp: 50, atk: 75, def: 35, type: ['Planta', 'Veneno'], moves: ['Vine Whip'] },
  'Weepinbell': { hp: 65, atk: 90, def: 50, type: ['Planta', 'Veneno'], moves: ['Razor Leaf', 'Acid'] },
  'Victreebel': { hp: 80, atk: 105, def: 65, type: ['Planta', 'Veneno'], moves: ['Razor Leaf', 'Sludge Bomb'] },
  'Tentacool': { hp: 40, atk: 40, def: 35, type: ['Agua', 'Veneno'], moves: ['Poison Sting', 'Water Gun'] },
  'Tentacruel': { hp: 80, atk: 70, def: 65, type: ['Agua', 'Veneno'], moves: ['Surf', 'Sludge Bomb'] },
  'Geodude': { hp: 40, atk: 80, def: 100, type: ['Roca', 'Tierra'], moves: ['Rock Throw', 'Tackle'] },
  'Graveler': { hp: 55, atk: 95, def: 115, type: ['Roca', 'Tierra'], moves: ['Rock Slide', 'Earthquake'] },
  'Golem': { hp: 80, atk: 110, def: 130, type: ['Roca', 'Tierra'], moves: ['Rock Slide', 'Earthquake'] },
  'Ponyta': { hp: 50, atk: 85, def: 55, type: ['Fuego'], moves: ['Ember', 'Stomp'] },
  'Rapidash': { hp: 65, atk: 100, def: 70, type: ['Fuego'], moves: ['Fire Blast', 'Agility'] },
  'Slowpoke': { hp: 90, atk: 65, def: 65, type: ['Agua', 'Ps√≠quico'], moves: ['Confusion', 'Water Gun'] },
  'Slowbro': { hp: 95, atk: 75, def: 110, type: ['Agua', 'Ps√≠quico'], moves: ['Surf', 'Psychic'] },
  'Magnemite': { hp: 25, atk: 35, def: 70, type: ['El√©ctrico', 'Acero'], moves: ['Thunder Shock', 'Sonic Boom'] },
  'Magneton': { hp: 50, atk: 60, def: 95, type: ['El√©ctrico', 'Acero'], moves: ['Thunderbolt', 'Tri Attack'] },
  'Farfetch\'d': { hp: 52, atk: 65, def: 55, type: ['Normal', 'Volador'], moves: ['Slash', 'Swords Dance'] }
};

const POKEMON_PART_2 = {
  'Doduo': { hp: 35, atk: 85, def: 45, type: ['Normal', 'Volador'], moves: ['Peck', 'Fury Attack'] },
  'Dodrio': { hp: 60, atk: 110, def: 70, type: ['Normal', 'Volador'], moves: ['Drill Peck', 'Tri Attack'] },
  'Seel': { hp: 65, atk: 45, def: 55, type: ['Agua'], moves: ['Headbutt', 'Icy Wind'] },
  'Dewgong': { hp: 90, atk: 70, def: 80, type: ['Agua', 'Hielo'], moves: ['Aurora Beam', 'Surf'] },
  'Grimer': { hp: 80, atk: 80, def: 50, type: ['Veneno'], moves: ['Pound', 'Sludge'] },
  'Muk': { hp: 105, atk: 105, def: 75, type: ['Veneno'], moves: ['Sludge Bomb', 'Acid Armor'] },
  'Shellder': { hp: 30, atk: 65, def: 100, type: ['Agua'], moves: ['Tackle', 'Clamp'] },
  'Cloyster': { hp: 50, atk: 95, def: 180, type: ['Agua', 'Hielo'], moves: ['Spike Cannon', 'Ice Beam'] },
  'Gastly': { hp: 30, atk: 35, def: 30, type: ['Fantasma', 'Veneno'], moves: ['Lick', 'Hypnosis'] },
  'Haunter': { hp: 45, atk: 50, def: 45, type: ['Fantasma', 'Veneno'], moves: ['Lick', 'Shadow Ball'] },
  'Gengar': { hp: 60, atk: 65, def: 60, type: ['Fantasma', 'Veneno'], moves: ['Shadow Ball', 'Hypnosis'] },
  'Onix': { hp: 35, atk: 45, def: 160, type: ['Roca', 'Tierra'], moves: ['Rock Throw', 'Bind'] },
  'Drowzee': { hp: 60, atk: 48, def: 45, type: ['Ps√≠quico'], moves: ['Pound', 'Hypnosis'] },
  'Hypno': { hp: 85, atk: 73, def: 70, type: ['Ps√≠quico'], moves: ['Psychic', 'Headbutt'] },
  'Krabby': { hp: 30, atk: 105, def: 90, type: ['Agua'], moves: ['Bubble', 'Vice Grip'] },
  'Kingler': { hp: 55, atk: 130, def: 115, type: ['Agua'], moves: ['Crabhammer', 'Stomp'] },
  'Voltorb': { hp: 40, atk: 30, def: 50, type: ['El√©ctrico'], moves: ['Tackle', 'Spark'] },
  'Electrode': { hp: 60, atk: 50, def: 70, type: ['El√©ctrico'], moves: ['Thunderbolt', 'Explosion'] },
  'Exeggcute': { hp: 60, atk: 40, def: 80, type: ['Planta', 'Ps√≠quico'], moves: ['Barrage', 'Hypnosis'] },
  'Exeggutor': { hp: 95, atk: 95, def: 85, type: ['Planta', 'Ps√≠quico'], moves: ['Psychic', 'Solar Beam'] },
  'Cubone': { hp: 50, atk: 50, def: 95, type: ['Tierra'], moves: ['Bone Club', 'Headbutt'] },
  'Marowak': { hp: 60, atk: 80, def: 110, type: ['Tierra'], moves: ['Bonemerang', 'Thrash'] },
  'Hitmonlee': { hp: 50, atk: 120, def: 53, type: ['Lucha'], moves: ['High Jump Kick', 'Rolling Kick'] },
  'Hitmonchan': { hp: 50, atk: 105, def: 79, type: ['Lucha'], moves: ['Mach Punch', 'Ice Punch'] },
  'Lickitung': { hp: 90, atk: 55, def: 75, type: ['Normal'], moves: ['Lick', 'Stomp'] },
  'Koffing': { hp: 40, atk: 65, def: 95, type: ['Veneno'], moves: ['Smog', 'Sludge'] },
  'Weezing': { hp: 65, atk: 90, def: 120, type: ['Veneno'], moves: ['Sludge Bomb', 'Explosion'] },
  'Rhyhorn': { hp: 80, atk: 85, def: 95, type: ['Tierra', 'Roca'], moves: ['Horn Attack', 'Stomp'] },
  'Rhydon': { hp: 105, atk: 130, def: 120, type: ['Tierra', 'Roca'], moves: ['Earthquake', 'Rock Slide'] },
  'Chansey': { hp: 250, atk: 5, def: 5, type: ['Normal'], moves: ['Soft-Boiled', 'Double-Edge'] },
  'Tangela': { hp: 65, atk: 55, def: 115, type: ['Planta'], moves: ['Vine Whip', 'Mega Drain'] },
  'Kangaskhan': { hp: 105, atk: 95, def: 80, type: ['Normal'], moves: ['Comet Punch', 'Mega Punch'] },
  'Horsea': { hp: 30, atk: 40, def: 70, type: ['Agua'], moves: ['Bubble', 'Water Gun'] },
  'Seadra': { hp: 55, atk: 65, def: 95, type: ['Agua'], moves: ['Hydro Pump', 'Twister'] },
  'Goldeen': { hp: 45, atk: 67, def: 60, type: ['Agua'], moves: ['Peck', 'Supersonic'] },
  'Seaking': { hp: 80, atk: 92, def: 65, type: ['Agua'], moves: ['Waterfall', 'Horn Drill'] },
  'Staryu': { hp: 30, atk: 45, def: 55, type: ['Agua'], moves: ['Tackle', 'Water Gun'] },
  'Starmie': { hp: 60, atk: 75, def: 85, type: ['Agua', 'Ps√≠quico'], moves: ['Surf', 'Psychic'] },
  'Mr. Mime': { hp: 40, atk: 45, def: 65, type: ['Ps√≠quico'], moves: ['Confusion', 'Barrier'] },
  'Scyther': { hp: 70, atk: 110, def: 80, type: ['Bicho', 'Volador'], moves: ['Slash', 'Wing Attack'] },
  'Jynx': { hp: 65, atk: 50, def: 35, type: ['Hielo', 'Ps√≠quico'], moves: ['Ice Punch', 'Lovely Kiss'] },
  'Electabuzz': { hp: 65, atk: 83, def: 57, type: ['El√©ctrico'], moves: ['Thunder Punch', 'Thunderbolt'] },
  'Magmar': { hp: 65, atk: 95, def: 57, type: ['Fuego'], moves: ['Fire Punch', 'Flamethrower'] },
  'Pinsir': { hp: 65, atk: 125, def: 100, type: ['Bicho'], moves: ['Vice Grip', 'Submission'] },
  'Tauros': { hp: 75, atk: 100, def: 95, type: ['Normal'], moves: ['Tackle', 'Take Down'] },
  'Magikarp': { hp: 20, atk: 10, def: 55, type: ['Agua'], moves: ['Splash', 'Tackle'] },
  'Gyarados': { hp: 95, atk: 125, def: 79, type: ['Agua', 'Volador'], moves: ['Hydro Pump', 'Dragon Rage'] },
  'Lapras': { hp: 130, atk: 85, def: 80, type: ['Agua', 'Hielo'], moves: ['Surf', 'Ice Beam'] },
  'Ditto': { hp: 48, atk: 48, def: 48, type: ['Normal'], moves: ['Transform'] },
  'Eevee': { hp: 55, atk: 55, def: 50, type: ['Normal'], moves: ['Tackle', 'Quick Attack'] },
  'Vaporeon': { hp: 130, atk: 65, def: 60, type: ['Agua'], moves: ['Surf', 'Acid Armor'] },
  'Jolteon': { hp: 65, atk: 65, def: 60, type: ['El√©ctrico'], moves: ['Thunderbolt', 'Pin Missile'] },
  'Flareon': { hp: 65, atk: 130, def: 60, type: ['Fuego'], moves: ['Flamethrower', 'Fire Blast'] },
  'Porygon': { hp: 65, atk: 60, def: 70, type: ['Normal'], moves: ['Tri Attack', 'Conversion'] },
  'Omanyte': { hp: 35, atk: 40, def: 100, type: ['Roca', 'Agua'], moves: ['Water Gun', 'Withdraw'] },
  'Omastar': { hp: 70, atk: 60, def: 125, type: ['Roca', 'Agua'], moves: ['Spike Cannon', 'Hydro Pump'] },
  'Kabuto': { hp: 30, atk: 80, def: 90, type: ['Roca', 'Agua'], moves: ['Scratch', 'Harden'] },
  'Kabutops': { hp: 60, atk: 115, def: 105, type: ['Roca', 'Agua'], moves: ['Slash', 'Mega Drain'] },
  'Aerodactyl': { hp: 80, atk: 105, def: 65, type: ['Roca', 'Volador'], moves: ['Wing Attack', 'Ancient Power'] },
  'Snorlax': { hp: 160, atk: 110, def: 65, type: ['Normal'], moves: ['Body Slam', 'Rest'] },
  'Articuno': { hp: 90, atk: 85, def: 100, type: ['Hielo', 'Volador'], moves: ['Ice Beam', 'Blizzard'] },
  'Zapdos': { hp: 90, atk: 90, def: 85, type: ['El√©ctrico', 'Volador'], moves: ['Drill Peck', 'Thunderbolt'] },
  'Moltres': { hp: 90, atk: 100, def: 90, type: ['Fuego', 'Volador'], moves: ['Fire Blast', 'Sky Attack'] },
  'Dratini': { hp: 41, atk: 64, def: 45, type: ['Drag√≥n'], moves: ['Wrap', 'Thunder Wave'] },
  'Dragonair': { hp: 61, atk: 84, def: 65, type: ['Drag√≥n'], moves: ['Slam', 'Dragon Rage'] },
  'Dragonite': { hp: 91, atk: 134, def: 95, type: ['Drag√≥n', 'Volador'], moves: ['Outrage', 'Wing Attack'] },
  'Mewtwo': { hp: 106, atk: 110, def: 90, type: ['Ps√≠quico'], moves: ['Psychic', 'Recover'] },
  'Mew': { hp: 100, atk: 100, def: 100, type: ['Ps√≠quico'], moves: ['Psychic', 'Metronome'] },
  'Chikorita': { hp: 45, atk: 49, def: 65, type: ['Planta'], moves: ['Tackle', 'Razor Leaf'] },
  'Bayleef': { hp: 60, atk: 62, def: 80, type: ['Planta'], moves: ['Razor Leaf', 'Reflect'] },
  'Meganium': { hp: 80, atk: 82, def: 100, type: ['Planta'], moves: ['Solar Beam', 'Synthesis'] },
  'Cyndaquil': { hp: 39, atk: 52, def: 43, type: ['Fuego'], moves: ['Tackle', 'Ember'] },
  'Quilava': { hp: 58, atk: 64, def: 58, type: ['Fuego'], moves: ['Flame Wheel', 'Quick Attack'] },
  'Typhlosion': { hp: 78, atk: 84, def: 78, type: ['Fuego'], moves: ['Flamethrower', 'Thunder Punch'] },
  'Totodile': { hp: 50, atk: 65, def: 64, type: ['Agua'], moves: ['Scratch', 'Water Gun'] },
  'Croconaw': { hp: 65, atk: 80, def: 80, type: ['Agua'], moves: ['Bite', 'Water Gun'] },
  'Feraligatr': { hp: 85, atk: 105, def: 100, type: ['Agua'], moves: ['Hydro Pump', 'Slash'] },
  'Sentret': { hp: 35, atk: 46, def: 34, type: ['Normal'], moves: ['Tackle', 'Quick Attack'] },
  'Furret': { hp: 85, atk: 76, def: 64, type: ['Normal'], moves: ['Quick Attack', 'Slam'] },
  'Hoothoot': { hp: 60, atk: 30, def: 30, type: ['Normal', 'Volador'], moves: ['Peck', 'Hypnosis'] },
  'Noctowl': { hp: 100, atk: 50, def: 50, type: ['Normal', 'Volador'], moves: ['Take Down', 'Dream Eater'] },
  'Ledyba': { hp: 40, atk: 20, def: 30, type: ['Bicho', 'Volador'], moves: ['Tackle', 'Comet Punch'] },
  'Ledian': { hp: 55, atk: 35, def: 50, type: ['Bicho', 'Volador'], moves: ['Comet Punch', 'Reflect'] },
  'Spinarak': { hp: 40, atk: 60, def: 40, type: ['Bicho', 'Veneno'], moves: ['Poison Sting', 'Constrict'] },
  'Ariados': { hp: 70, atk: 90, def: 70, type: ['Bicho', 'Veneno'], moves: ['Sludge Bomb', 'Psychic'] }
};

const POKEMON_PART_3 = {
  'Crobat': { hp: 85, atk: 90, def: 80, type: ['Veneno', 'Volador'], moves: ['Wing Attack', 'Confuse Ray'] },
  'Chinchou': { hp: 75, atk: 38, def: 38, type: ['Agua', 'El√©ctrico'], moves: ['Bubble', 'Thunder Wave'] },
  'Lanturn': { hp: 125, atk: 58, def: 58, type: ['Agua', 'El√©ctrico'], moves: ['Surf', 'Thunderbolt'] },
  'Pichu': { hp: 20, atk: 40, def: 15, type: ['El√©ctrico'], moves: ['Thunder Shock', 'Charm'] },
  'Cleffa': { hp: 50, atk: 25, def: 28, type: ['Normal'], moves: ['Pound', 'Charm'] },
  'Igglybuff': { hp: 90, atk: 30, def: 15, type: ['Normal'], moves: ['Sing', 'Charm'] },
  'Togepi': { hp: 35, atk: 20, def: 65, type: ['Normal'], moves: ['Metronome', 'Charm'] },
  'Togetic': { hp: 55, atk: 40, def: 85, type: ['Normal', 'Volador'], moves: ['Double-Edge', 'Metronome'] },
  'Natu': { hp: 40, atk: 50, def: 45, type: ['Ps√≠quico', 'Volador'], moves: ['Peck', 'Night Shade'] },
  'Xatu': { hp: 65, atk: 75, def: 70, type: ['Ps√≠quico', 'Volador'], moves: ['Psychic', 'Fly'] },
  'Mareep': { hp: 55, atk: 40, def: 40, type: ['El√©ctrico'], moves: ['Tackle', 'Thunder Shock'] },
  'Flaaffy': { hp: 70, atk: 55, def: 55, type: ['El√©ctrico'], moves: ['Thunder Shock', 'Thunder Wave'] },
  'Ampharos': { hp: 90, atk: 75, def: 75, type: ['El√©ctrico'], moves: ['Thunder Punch', 'Thunder'] },
  'Bellossom': { hp: 75, atk: 80, def: 85, type: ['Planta'], moves: ['Petal Dance', 'Solar Beam'] },
  'Marill': { hp: 70, atk: 20, def: 50, type: ['Agua'], moves: ['Tackle', 'Water Gun'] },
  'Azumarill': { hp: 100, atk: 50, def: 80, type: ['Agua'], moves: ['Bubble Beam', 'Rollout'] },
  'Sudowoodo': { hp: 70, atk: 100, def: 115, type: ['Roca'], moves: ['Rock Slide', 'Low Kick'] },
  'Politoed': { hp: 90, atk: 75, def: 75, type: ['Agua'], moves: ['Surf', 'Perish Song'] },
  'Hoppip': { hp: 35, atk: 35, def: 40, type: ['Planta', 'Volador'], moves: ['Splash', 'Synthesis'] },
  'Skiploom': { hp: 55, atk: 45, def: 50, type: ['Planta', 'Volador'], moves: ['Tackle', 'Leech Seed'] },
  'Jumpluff': { hp: 75, atk: 55, def: 70, type: ['Planta', 'Volador'], moves: ['Cotton Spore', 'Mega Drain'] },
  'Aipom': { hp: 55, atk: 70, def: 55, type: ['Normal'], moves: ['Scratch', 'Baton Pass'] },
  'Sunkern': { hp: 30, atk: 30, def: 30, type: ['Planta'], moves: ['Absorb', 'Growth'] },
  'Sunflora': { hp: 75, atk: 75, def: 55, type: ['Planta'], moves: ['Petal Dance', 'Solar Beam'] },
  'Yanma': { hp: 65, atk: 65, def: 45, type: ['Bicho', 'Volador'], moves: ['Tackle', 'Sonic Boom'] },
  'Wooper': { hp: 55, atk: 45, def: 45, type: ['Agua', 'Tierra'], moves: ['Water Gun', 'Mud-Slap'] },
  'Quagsire': { hp: 95, atk: 85, def: 85, type: ['Agua', 'Tierra'], moves: ['Earthquake', 'Surf'] },
  'Espeon': { hp: 65, atk: 65, def: 60, type: ['Ps√≠quico'], moves: ['Psychic', 'Morning Sun'] },
  'Umbreon': { hp: 95, atk: 65, def: 110, type: ['Siniestro'], moves: ['Faint Attack', 'Confuse Ray'] },
  'Murkrow': { hp: 60, atk: 85, def: 42, type: ['Siniestro', 'Volador'], moves: ['Peck', 'Faint Attack'] },
  'Slowking': { hp: 95, atk: 75, def: 80, type: ['Agua', 'Ps√≠quico'], moves: ['Psychic', 'Surf'] },
  'Misdreavus': { hp: 60, atk: 60, def: 60, type: ['Fantasma'], moves: ['Psybeam', 'Pain Split'] },
  'Unown': { hp: 48, atk: 72, def: 48, type: ['Ps√≠quico'], moves: ['Hidden Power'] },
  'Wobbuffet': { hp: 190, atk: 33, def: 58, type: ['Ps√≠quico'], moves: ['Counter', 'Mirror Coat'] },
  'Girafarig': { hp: 70, atk: 80, def: 65, type: ['Normal', 'Ps√≠quico'], moves: ['Stomp', 'Psybeam'] },
  'Pineco': { hp: 50, atk: 65, def: 90, type: ['Bicho'], moves: ['Tackle', 'Self-Destruct'] },
  'Forretress': { hp: 75, atk: 90, def: 140, type: ['Bicho', 'Acero'], moves: ['Explosion', 'Spikes'] },
  'Dunsparce': { hp: 100, atk: 70, def: 70, type: ['Normal'], moves: ['Glare', 'Headbutt'] },
  'Gligar': { hp: 65, atk: 75, def: 105, type: ['Tierra', 'Volador'], moves: ['Poison Sting', 'Faint Attack'] },
  'Steelix': { hp: 75, atk: 85, def: 200, type: ['Acero', 'Tierra'], moves: ['Iron Tail', 'Earthquake'] },
  'Snubbull': { hp: 60, atk: 80, def: 50, type: ['Normal'], moves: ['Tackle', 'Bite'] },
  'Granbull': { hp: 90, atk: 120, def: 75, type: ['Normal'], moves: ['Bite', 'Take Down'] },
  'Qwilfish': { hp: 65, atk: 95, def: 75, type: ['Agua', 'Veneno'], moves: ['Pin Missile', 'Sludge Bomb'] },
  'Scizor': { hp: 70, atk: 130, def: 100, type: ['Bicho', 'Acero'], moves: ['Metal Claw', 'Slash'] },
  'Shuckle': { hp: 20, atk: 10, def: 230, type: ['Bicho', 'Roca'], moves: ['Wrap', 'Toxic'] },
  'Heracross': { hp: 80, atk: 125, def: 75, type: ['Bicho', 'Lucha'], moves: ['Megahorn', 'Reversal'] },
  'Sneasel': { hp: 55, atk: 95, def: 55, type: ['Siniestro', 'Hielo'], moves: ['Faint Attack', 'Icy Wind'] },
  'Teddiursa': { hp: 60, atk: 80, def: 50, type: ['Normal'], moves: ['Scratch', 'Lick'] },
  'Ursaring': { hp: 90, atk: 130, def: 75, type: ['Normal'], moves: ['Slash', 'Faint Attack'] },
  'Slugma': { hp: 40, atk: 40, def: 40, type: ['Fuego'], moves: ['Smog', 'Ember'] },
  'Magcargo': { hp: 50, atk: 50, def: 120, type: ['Fuego', 'Roca'], moves: ['Flamethrower', 'Rock Slide'] },
  'Swinub': { hp: 50, atk: 50, def: 40, type: ['Hielo', 'Tierra'], moves: ['Tackle', 'Powder Snow'] },
  'Piloswine': { hp: 100, atk: 100, def: 80, type: ['Hielo', 'Tierra'], moves: ['Blizzard', 'Earthquake'] },
  'Corsola': { hp: 55, atk: 55, def: 85, type: ['Agua', 'Roca'], moves: ['Bubble Beam', 'Recover'] },
  'Remoraid': { hp: 35, atk: 65, def: 35, type: ['Agua'], moves: ['Water Gun', 'Aurora Beam'] },
  'Octillery': { hp: 75, atk: 105, def: 75, type: ['Agua'], moves: ['Octazooka', 'Ice Beam'] },
  'Delibird': { hp: 45, atk: 55, def: 45, type: ['Hielo', 'Volador'], moves: ['Present'] },
  'Mantine': { hp: 65, atk: 40, def: 70, type: ['Agua', 'Volador'], moves: ['Bubble Beam', 'Wing Attack'] },
  'Skarmory': { hp: 65, atk: 80, def: 140, type: ['Acero', 'Volador'], moves: ['Peck', 'Steel Wing'] },
  'Houndour': { hp: 45, atk: 60, def: 30, type: ['Siniestro', 'Fuego'], moves: ['Ember', 'Bite'] },
  'Houndoom': { hp: 75, atk: 90, def: 50, type: ['Siniestro', 'Fuego'], moves: ['Crunch', 'Flamethrower'] },
  'Kingdra': { hp: 75, atk: 95, def: 95, type: ['Agua', 'Drag√≥n'], moves: ['Hydro Pump', 'Dragon Breath'] },
  'Phanpy': { hp: 90, atk: 60, def: 60, type: ['Tierra'], moves: ['Tackle', 'Rollout'] },
  'Donphan': { hp: 90, atk: 120, def: 120, type: ['Tierra'], moves: ['Earthquake', 'Rollout'] },
  'Porygon2': { hp: 85, atk: 80, def: 90, type: ['Normal'], moves: ['Tri Attack', 'Conversion 2'] },
  'Stantler': { hp: 73, atk: 95, def: 62, type: ['Normal'], moves: ['Stomp', 'Hypnosis'] },
  'Smeargle': { hp: 55, atk: 20, def: 35, type: ['Normal'], moves: ['Sketch'] },
  'Tyrogue': { hp: 35, atk: 35, def: 35, type: ['Lucha'], moves: ['Tackle'] },
  'Hitmontop': { hp: 50, atk: 95, def: 95, type: ['Lucha'], moves: ['Rolling Kick', 'Rapid Spin'] },
  'Smoochum': { hp: 45, atk: 30, def: 15, type: ['Hielo', 'Ps√≠quico'], moves: ['Pound', 'Sweet Kiss'] },
  'Elekid': { hp: 45, atk: 63, def: 37, type: ['El√©ctrico'], moves: ['Thunder Punch', 'Quick Attack'] },
  'Magby': { hp: 45, atk: 75, def: 37, type: ['Fuego'], moves: ['Ember', 'Smog'] },
  'Miltank': { hp: 95, atk: 80, def: 105, type: ['Normal'], moves: ['Stomp', 'Milk Drink'] },
  'Blissey': { hp: 255, atk: 10, def: 10, type: ['Normal'], moves: ['Soft-Boiled', 'Double-Edge'] },
  'Raikou': { hp: 90, atk: 85, def: 75, type: ['El√©ctrico'], moves: ['Thunder', 'Spark'] },
  'Entei': { hp: 115, atk: 115, def: 85, type: ['Fuego'], moves: ['Fire Blast', 'Stomp'] },
  'Suicune': { hp: 100, atk: 75, def: 115, type: ['Agua'], moves: ['Hydro Pump', 'Bubble Beam'] },
  'Larvitar': { hp: 50, atk: 64, def: 50, type: ['Roca', 'Tierra'], moves: ['Bite', 'Rock Slide'] },
  'Pupitar': { hp: 70, atk: 84, def: 70, type: ['Roca', 'Tierra'], moves: ['Rock Slide', 'Dark Pulse'] },
  'Tyranitar': { hp: 100, atk: 134, def: 110, type: ['Roca', 'Siniestro'], moves: ['Crunch', 'Earthquake'] },
  'Lugia': { hp: 106, atk: 90, def: 130, type: ['Ps√≠quico', 'Volador'], moves: ['Aeroblast', 'Psychic'] },
  'Ho-Oh': { hp: 106, atk: 130, def: 90, type: ['Fuego', 'Volador'], moves: ['Sacred Fire', 'Brave Bird'] },
  'Celebi': { hp: 100, atk: 100, def: 100, type: ['Ps√≠quico', 'Planta'], moves: ['Solar Beam', 'Psychic'] }
};

const POKEMON_SPECIES  = { ...POKEMON_PART_1, ...POKEMON_PART_2, ...POKEMON_PART_3 };

// Structure: Key is the ATTACKER. Values are the DEFENDERS and the multiplier.
// 1x damage is omitted for efficiency.

const TYPE_CHART = {
  'Normal': { 'Roca': 0.5, 'Acero': 0.5, 'Fantasma': 0 },
  'Fuego': { 'Planta': 2, 'Hielo': 2, 'Bicho': 2, 'Acero': 2, 'Fuego': 0.5, 'Agua': 0.5, 'Roca': 0.5, 'Drag√≥n': 0.5 },
  'Agua': { 'Fuego': 2, 'Tierra': 2, 'Roca': 2, 'Agua': 0.5, 'Planta': 0.5, 'Drag√≥n': 0.5 },
  'Planta': { 'Agua': 2, 'Tierra': 2, 'Roca': 2, 'Planta': 0.5, 'Fuego': 0.5, 'Veneno': 0.5, 'Volador': 0.5, 'Bicho': 0.5, 'Drag√≥n': 0.5, 'Acero': 0.5 },
  'El√©ctrico': { 'Agua': 2, 'Volador': 2, 'El√©ctrico': 0.5, 'Planta': 0.5, 'Drag√≥n': 0.5, 'Tierra': 0 },
  'Hielo': { 'Planta': 2, 'Tierra': 2, 'Volador': 2, 'Drag√≥n': 2, 'Fuego': 0.5, 'Agua': 0.5, 'Hielo': 0.5, 'Acero': 0.5 },
  'Lucha': { 'Normal': 2, 'Hielo': 2, 'Roca': 2, 'Siniestro': 2, 'Acero': 2, 'Veneno': 0.5, 'Volador': 0.5, 'Ps√≠quico': 0.5, 'Bicho': 0.5, 'Fantasma': 0 },
  'Veneno': { 'Planta': 2, 'Veneno': 0.5, 'Tierra': 0.5, 'Roca': 0.5, 'Fantasma': 0.5, 'Acero': 0 },
  'Tierra': { 'Fuego': 2, 'El√©ctrico': 2, 'Veneno': 2, 'Roca': 2, 'Acero': 2, 'Planta': 0.5, 'Bicho': 0.5, 'Volador': 0 },
  'Volador': { 'Planta': 2, 'Lucha': 2, 'Bicho': 2, 'El√©ctrico': 0.5, 'Roca': 0.5, 'Acero': 0.5 },
  'Ps√≠quico': { 'Lucha': 2, 'Veneno': 2, 'Ps√≠quico': 0.5, 'Acero': 0.5, 'Siniestro': 0 },
  'Bicho': { 'Planta': 2, 'Ps√≠quico': 2, 'Siniestro': 2, 'Fuego': 0.5, 'Lucha': 0.5, 'Veneno': 0.5, 'Volador': 0.5, 'Fantasma': 0.5, 'Acero': 0.5 },
  'Roca': { 'Fuego': 2, 'Hielo': 2, 'Volador': 2, 'Bicho': 2, 'Lucha': 0.5, 'Tierra': 0.5, 'Acero': 0.5 },
  'Fantasma': { 'Ps√≠quico': 2, 'Fantasma': 2, 'Siniestro': 0.5, 'Acero': 0.5, 'Normal': 0 },
  'Drag√≥n': { 'Drag√≥n': 2, 'Acero': 0.5 },
  'Acero': { 'Hielo': 2, 'Roca': 2, 'Fuego': 0.5, 'Agua': 0.5, 'El√©ctrico': 0.5, 'Acero': 0.5 },
  'Siniestro': { 'Ps√≠quico': 2, 'Fantasma': 2, 'Lucha': 0.5, 'Siniestro': 0.5, 'Acero': 0.5 }
};

/* =========================================================
   GAME STATE
========================================================= */
let state = {
  team: [],
  inventory: { balls: 0, potions: 0 },
  streak: 0,
  activeIdx: 0,
  gameMode: 'normal' // 'normal' or 'nuzlocke'
};
let opponent = null;
let turnLock = false;

/* =========================================================
   CLASSES
========================================================= */
class Pokemon {
  constructor(name, level, isNuzlocke = false) {
    const data = POKEMON_SPECIES[name];
    this.name = name;
    this.level = level;
    this.types = data.type;
    this.xp = 0;
    this.xpToNext = level * 60 + 100;
    this.isShiny = Math.random() < CONSTANTS.SHINY_CHANCE;
    this.status = null; // 'BRN', 'PSN', 'PAR', 'SLP', 'FRZ'
    
    // Stats Calculator 
    this.maxHp = Math.floor(0.01 * (2 * data.hp) * level) + level + 10;
    this.hp = this.maxHp;
    this.atk = Math.floor(0.01 * (2 * data.atk) * level) + 5;
    this.def = Math.floor(0.01 * (2 * data.def) * level) + 5;
    
    // Move Logic based on Mode
    if (isNuzlocke) {
      // Random moves from global pool
      const allMoves = Object.keys(MOVES);
      this.moves = [];
      const numMoves = Math.min(4, Math.max(1, Math.floor(level / 5)));
      for(let i=0; i<numMoves; i++) {
        const rnd = allMoves[Math.floor(Math.random() * allMoves.length)];
        if(!this.moves.includes(rnd)) this.moves.push(rnd);
      }
    } else {
      this.moves = (data.moves || ['Tackle']).filter(mName => MOVES[mName]);
      if (this.moves.length === 0) this.moves = ['Tackle'];
    }
  }
}

/* =========================================================
   HELPERS & VFX
========================================================= */
const $ = id => document.getElementById(id);
const wait = ms => new Promise(r => setTimeout(r, ms));

function log(msg) {
  const div = document.createElement('div');
  div.innerHTML = msg;
  div.style.marginBottom = '4px';
  $('combat-log').prepend(div);
  if ($('combat-log').children.length > 20) $('combat-log').lastChild.remove();
}

function getEffectIcon(type) {
  const icons = {
    'Fuego': 'üî•', 'Agua': 'üíß', 'Planta': 'üçÉ', 'El√©ctrico': '‚ö°', 
    'Roca': 'ü™®', 'Tierra': 'üèúÔ∏è', 'Volador': 'üå™Ô∏è', 'Ps√≠quico': 'üîÆ',
    'Fantasma': 'üëª', 'Hielo': '‚ùÑÔ∏è', 'Veneno': '‚ò†Ô∏è', 'Lucha': 'ü•ä',
    'Bicho': 'ü¶ü', 'Drag√≥n': 'üêâ', 'Normal': 'üí•'
  };
  return icons[type] || 'üí•';
}

function getProjectileClass(type) {
  const map = {
    'Fuego': 'proj-fire', 'Agua': 'proj-water', 'Planta': 'proj-grass', 
    'El√©ctrico': 'proj-electric', 'Roca': 'proj-rock', 'Fantasma': 'proj-ghost'
  };
  return map[type] || 'proj-normal';
}

async function shootProjectile(type, fromId, toId) {
  const fromEl = $(fromId);
  const toEl = $(toId);
  const layer = $('vfx-layer');
  if (!fromEl || !toEl) return;

  const r1 = fromEl.getBoundingClientRect();
  const r2 = toEl.getBoundingClientRect();
  const parent = layer.getBoundingClientRect();

  const startX = r1.left - parent.left + r1.width/2;
  const startY = r1.top - parent.top + r1.height/2;
  const endX = r2.left - parent.left + r2.width/2;
  const endY = r2.top - parent.top + r2.height/2;

  const p = document.createElement('div');
  p.className = `projectile ${getProjectileClass(type)}`;
  p.style.left = (startX - 16) + 'px';
  p.style.top = (startY - 16) + 'px';
  
  layer.appendChild(p);
  p.getBoundingClientRect(); 
  
  p.style.left = (endX - 16) + 'px';
  p.style.top = (endY - 16) + 'px';
  
  await wait(400); 
  p.remove();
}

function spawnParticles(type, targetEl) {
  const rect = targetEl.getBoundingClientRect();
  const parent = $('vfx-layer').getBoundingClientRect();
  const centerX = rect.left - parent.left + rect.width / 2;
  const centerY = rect.top - parent.top + rect.height / 2;
  const icon = getEffectIcon(type);

  for(let i=0; i<6; i++) {
    const p = document.createElement('div');
    p.classList.add('vfx-particle');
    p.textContent = icon;
    p.style.left = centerX + 'px';
    p.style.top = centerY + 'px';
    
    const angle = Math.random() * 360;
    const dist = 30 + Math.random() * 40;
    const tx = Math.cos(angle * Math.PI / 180) * dist + 'px';
    const ty = Math.sin(angle * Math.PI / 180) * dist + 'px';
    const rot = (Math.random() * 360) + 'deg';
    
    p.style.setProperty('--tx', tx);
    p.style.setProperty('--ty', ty);
    p.style.setProperty('--rot', rot);

    $('vfx-layer').appendChild(p);
    setTimeout(() => p.remove(), 600);
  }
}

async function animateAttack(attackerSlotId, type) {
  const el = $(attackerSlotId);
  const isPlayer = attackerSlotId.includes('player');
  const animClass = isPlayer ? 'anim-attack-player' : 'anim-attack-opponent';
  
  el.classList.remove('anim-idle');
  el.classList.add(animClass);
  await wait(300);
  el.classList.remove(animClass);
  el.classList.add('anim-idle');
}

async function animateDamage(victimSlotId) {
  const el = $(victimSlotId);
  el.classList.add('anim-damage');
  $('battle-scene').classList.add('shake-screen');
  await wait(500);
  el.classList.remove('anim-damage');
  $('battle-scene').classList.remove('shake-screen');
}

/* =========================================================
   CORE LOGIC
========================================================= */
function initGame() {
  $('btn-load').disabled = !localStorage.getItem('poke_save');
}

function startGame(mode) {
  state.gameMode = mode;
  state.streak = 0;
  state.inventory.balls = CONSTANTS.START_BALLS;
  state.inventory.pots = CONSTANTS.START_POTS;
  state.activeIdx = 0;
  
  // Starter Logic
  let keys;
  if (mode === 'nuzlocke') {
    keys = Object.keys(POKEMON_SPECIES); // Any pokemon
  } else {
    keys = Object.keys(POKEMON_SPECIES).filter(k => POKEMON_SPECIES[k].tier === 1); // Use filtered tier 1 if exists, else all
    if (keys.length === 0) keys = Object.keys(POKEMON_SPECIES);
  }
  
  const randomStarter = keys[Math.floor(Math.random() * keys.length)];
  state.team = [new Pokemon(randomStarter, 5, mode === 'nuzlocke')]; 
  
  $('start-buttons').style.display = 'none';
  $('game-title').classList.add('hidden-title');
  $('mode-display').innerText = mode === 'nuzlocke' ? '‚ò†Ô∏è Nuzlocke' : 'Normal';
  
  $('combat-log').innerHTML = mode === 'nuzlocke' 
    ? "üíÄ Modo Nuzlocke iniciado. ¬°Si mueren, no vuelven!" 
    : "Bienvenido a Kanto Rogue."; 
  
  closeSwitchMenu(); 
  turnLock = false; 
  startBattle();
}

function getTeamAverageLevel() {
  if (state.team.length === 0) return 5;
  const total = state.team.reduce((sum, p) => sum + p.level, 0);
  return Math.floor(total / state.team.length);
}

function startBattle() {
  // Clear status of player team at start of battle (Requested Feature)
  state.team.forEach(p => p.status = null);

  // Background
  const bgs = ['bg-forest', 'bg-cave', 'bg-ocean', 'bg-night', 'bg-volcano'];
  const newBg = bgs[Math.floor(Math.random() * bgs.length)];
  $('battle-scene').className = newBg;

  // Opponent Gen
  const avgLevel = getTeamAverageLevel();
  let targetLevel;
  if (avgLevel < 15) targetLevel = Math.max(2, avgLevel - 2 + Math.floor(Math.random() * 3)); 
  else if (avgLevel < 30) targetLevel = avgLevel + Math.floor(Math.random() * 2); 
  else targetLevel = avgLevel + Math.floor(Math.random() * 4);
  
  let validKeys = Object.keys(POKEMON_SPECIES);
  
  const pIdx = Math.floor(Math.random() * validKeys.length);
  // Nuzlocke opponents also get random moves? Yes, consistent with chaos.
  opponent = new Pokemon(validKeys[pIdx], targetLevel, state.gameMode === 'nuzlocke');
  
  const shinyText = opponent.isShiny ? '‚ú® ' : '';
  log(`‚ö†Ô∏è ¬°Un ${shinyText}<b>${opponent.name}</b> Nvl ${opponent.level} salvaje apareci√≥!`);
  
  turnLock = false; 
  renderAll();
}

function renderAll() {
  const player = state.team[state.activeIdx];
  // Safe check if activeIdx is -1 or out of bounds (Nuzlocke death handling)
  if(!player && state.team.length > 0 && state.activeIdx >= 0) {
    state.activeIdx = 0;
  }
  const currentP = state.team[state.activeIdx];
  
  if(!currentP) return;

  const renderBox = (mon, id, isPlayer) => {
    const hpPct = (mon.hp / mon.maxHp) * 100;
    const color = hpPct > 50 ? '#4caf50' : hpPct > 20 ? '#ffeb3b' : '#f44336';
    const container = $(id);
    const shinyMark = mon.isShiny ? '<span style="color:gold; text-shadow:0 0 5px orange">‚ú®</span> ' : '';
    
    let xpHTML = '';
    if (isPlayer) {
      const xpPct = (mon.xp / mon.xpToNext) * 100;
      xpHTML = `<div class="xp-container"><div class="xp-fill" style="width:${xpPct}%"></div></div>`;
    }

    const statusHTML = mon.status ? `<span class="status-tag status-${mon.status}">${mon.status}</span>` : '';

    container.innerHTML = `
      <div class="poke-name"><span>${shinyMark}${mon.name}</span> <span class="poke-lvl">Nv${mon.level}</span></div>
      <div class="hp-container">
        <div class="hp-fill" style="width:${hpPct}%; background:${color}"></div>
      </div>
      ${xpHTML}
      <div class="hp-text">${statusHTML}${mon.hp}/${mon.maxHp}</div>
    `;
  };

  renderBox(currentP, 'player-box', true);
  renderBox(opponent, 'opponent-box', false);

  const fetchSprite = async (mon, slot, back) => {
    const slug = SLUG_MAP[mon.name] || mon.name.toLowerCase();
    const uniqueId = `${mon.name}-${mon.isShiny ? 'shiny' : 'norm'}-${back?'back':'front'}`;
    const currentImg = $(slot).querySelector('img');

    if(currentImg && currentImg.dataset.uid === uniqueId) return;

    try {
      const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${slug}`);
      const data = await res.json();
      const anim = data.sprites.versions['generation-v']['black-white'].animated;
      let src;
      
      if (mon.isShiny) {
         src = back ? (anim.back_shiny || data.sprites.back_shiny) : (anim.front_shiny || data.sprites.front_shiny);
      } else {
         src = back ? (anim.back_default || data.sprites.back_default) : (anim.front_default || data.sprites.front_default);
      }
      if (!src) src = back ? data.sprites.back_default : data.sprites.front_default;

      $(slot).innerHTML = `<img src="${src}" class="sprite-img" data-uid="${uniqueId}">`;
    } catch(e) {
      $(slot).innerHTML = `<div style="font-size:3rem;">?</div>`;
    }
  };

  fetchSprite(currentP, 'player-sprite-slot', true);
  fetchSprite(opponent, 'opponent-sprite-slot', false);

  $('balls-val').innerText = state.inventory.balls;
  $('pots-val').innerText = state.inventory.pots;
  $('streak-val').innerText = state.streak;

  const movesHTML = currentP.moves.map(mKey => {
    const m = MOVES[mKey];
    if(!m) return '';
    return `
    <button class="btn-move type-${m.tipo}" onclick="doTurn('${mKey}')" ${turnLock?'disabled':''}>
      ${m.nombre}<br><small>${m.tipo} / ${m.poder}</small>
    </button>
  `}).join('');
  $('move-controls').innerHTML = movesHTML;
  
  $('btn-capture').disabled = turnLock || state.inventory.balls <= 0;
  $('btn-potion').disabled = turnLock || state.inventory.pots <= 0 || currentP.hp >= currentP.maxHp;
  $('btn-switch').disabled = turnLock || state.team.filter(p=>p.hp>0).length <= 1;
}

/* =========================================================
   BATTLE LOGIC
========================================================= */
async function executeMove(attacker, defender, move, isPlayer) {
  const atkSlot = isPlayer ? 'player-sprite-slot' : 'opponent-sprite-slot';
  const defSlot = isPlayer ? 'opponent-sprite-slot' : 'player-sprite-slot';
  const atkZone = isPlayer ? 'zone-player' : 'zone-opponent';
  const defZone = isPlayer ? 'zone-opponent' : 'zone-player';

  // Status Check (Start of Turn)
  if (attacker.status === 'FRZ') {
    if(Math.random() < 0.2) {
      attacker.status = null;
      log(`${isPlayer?'ü§†':'üòà'} ¬°${attacker.name} se descongel√≥!`);
    } else {
      log(`‚ùÑÔ∏è ${attacker.name} est√° congelado y no ataca.`);
      return;
    }
  }
  if (attacker.status === 'SLP') {
    if(Math.random() < 0.33) {
      attacker.status = null;
      log(`${isPlayer?'ü§†':'üòà'} ¬°${attacker.name} se despert√≥!`);
    } else {
      log(`üí§ ${attacker.name} duerme profundamente.`);
      return;
    }
  }
  if (attacker.status === 'PAR' && Math.random() < 0.25) {
    log(`‚ö° ${attacker.name} est√° paralizado y no puede moverse.`);
    return;
  }

  if(!move) {
     log(`${isPlayer ? 'üëä' : 'üîª'} ${attacker.name} falla su ataque.`);
     return;
  }

  log(`${isPlayer ? 'üëä' : 'üîª'} ${attacker.name} usa <b>${move.nombre}</b>!`);
  await animateAttack(atkSlot, move.tipo);
  await shootProjectile(move.tipo, atkZone, defZone);
  
  const dmg = calcDamage(attacker, defender, move);
  spawnParticles(move.tipo, $(defSlot));
  
  if (dmg.mult === 0) {
    log(`üö´ ¬°No afecta a ${defender.name}!`);
  } else {
    if(dmg.mult > 1) log(`‚ö° ¬°Es s√∫per efectivo!`);
    if(dmg.mult < 1) log(`üõ°Ô∏è No es muy efectivo...`);
    
    await animateDamage(defSlot);
    defender.hp = Math.max(0, defender.hp - dmg.amount);

    // Effect Chance
    if (move.effect && !defender.status && defender.hp > 0) {
      if (Math.random() < move.chance) {
        defender.status = move.effect;
        log(`‚ú® ¬°${defender.name} sufri√≥ <b>${move.effect}</b>!`);
      }
    }
  }
}

async function runStatusDamage(mon, isPlayer) {
  if (mon.hp <= 0) return;
  if (mon.status === 'BRN' || mon.status === 'PSN') {
    const dmg = Math.floor(mon.maxHp / 8);
    mon.hp = Math.max(0, mon.hp - dmg);
    await animateDamage(isPlayer ? 'player-sprite-slot' : 'opponent-sprite-slot');
    log(`${mon.status === 'BRN' ? 'üî•' : '‚ò†Ô∏è'} ${mon.name} sufre da√±o por ${mon.status}.`);
  }
}

async function doTurn(moveKey) {
  if(turnLock) return;
  turnLock = true;
  renderAll(); 

  const player = state.team[state.activeIdx];
  const move = MOVES[moveKey];

  // 1. Player Turn
  await executeMove(player, opponent, move, true);
  renderAll();

  if(opponent.hp <= 0) {
    await handleWin();
    turnLock = false;
    renderAll();
    return;
  }

  // 2. Opponent Turn
  await wait(800);
  let oppMoveKey = null;
  if(opponent.moves.length > 0) {
    oppMoveKey = opponent.moves[Math.floor(Math.random() * opponent.moves.length)];
  }
  const oppMove = oppMoveKey ? MOVES[oppMoveKey] : null;
  
  await executeMove(opponent, player, oppMove, false);
  renderAll();

  // 3. End of Turn Effects
  await runStatusDamage(player, true);
  if(player.hp > 0) await runStatusDamage(opponent, false); // If opponent alive
  renderAll();

  if(player.hp <= 0) {
    log(`‚ò†Ô∏è ¬°${player.name} se debilit√≥!`);
    if (state.gameMode === 'nuzlocke') {
      log(`‚ö∞Ô∏è Nuzlocke: ¬°${player.name} ha muerto para siempre!`);
      // Remove dead pokemon
      state.team.splice(state.activeIdx, 1);
      // activeIdx might now be out of bounds or point to next pokemon
      // FIX: Set activeIdx to -1 to force user selection instead of auto-switching to next index
      state.activeIdx = -1; 
    }
    checkDefeat(); 
  } else {
    turnLock = false;
    renderAll();
  }
}

function calcDamage(atkMon, defMon, move) {
  let mult = 1;
  if (TYPE_CHART[move.tipo]) {
    defMon.types.forEach(t => {
      if (TYPE_CHART[move.tipo][t] !== undefined) mult *= TYPE_CHART[move.tipo][t];
    });
  }
  if (mult === 0) return { amount: 0, mult: 0 }; 

  // Burn reduces physical damage
  let atkStat = atkMon.atk;
  if (atkMon.status === 'BRN' && move.cat === 'Fis') atkStat = Math.floor(atkStat * 0.5);

  const ad = move.cat === 'Fis' ? (atkStat / defMon.def) : ((atkMon.spa || atkStat) / (defMon.spd || defMon.def));
  const base = ((2 * atkMon.level / 5 + 2) * move.poder * ad) / 50 + 2;
  const total = Math.floor(base * mult * (Math.random() * 0.15 + 0.85)); 
  return { amount: total, mult: mult };
}

/* =========================================================
   POST-BATTLE
========================================================= */
async function handleWin() {
  log(`üèÜ ¬°Ganaste! ${opponent.name} debilitado.`);
  state.streak++;
  
  const teamSizeBonus = 1 + (state.team.length * 0.15); 
  const baseXP = ((opponent.level * 40) + 100) * CONSTANTS.XP_MULT * teamSizeBonus; 
  const shareXP = Math.floor(baseXP / state.team.length);
  
  for (let i = 0; i < state.team.length; i++) {
    const member = state.team[i];
    // Nuzlocke check: already removed if dead? 
    if (member.hp <= 0) continue; 

    let gain = (i === state.activeIdx) ? Math.floor(shareXP * 1.3) : shareXP;
    member.xp += gain;
    
    while (member.xp >= member.xpToNext) {
      member.xp -= member.xpToNext;
      member.level++;
      member.xpToNext = member.level * 60 + 100;
      member.maxHp += 2; member.hp = Math.min(member.hp + 2, member.maxHp); 
      member.atk += 1; member.def += 1;
      log(`üÜô ¬°${member.name} subi√≥ al Nvl ${member.level}!`);
      await checkEvolutionAndMoves(member);
      member.hp = member.maxHp;
    }
  }

  if(state.streak % CONSTANTS.HEAL_STREAK === 0) {
    state.team.forEach(p => p.hp = p.maxHp);
    state.inventory.balls = Math.min(CONSTANTS.MAX_BALLS, state.inventory.balls + 5);
    state.inventory.pots = Math.min(CONSTANTS.MAX_POTS, state.inventory.pots + 2);
    log(`üè• <b>Centro Pok√©mon:</b> ¬°Equipo curado y objetos repuestos!`);
  }

  await wait(1500);
  startBattle();
}

async function checkEvolutionAndMoves(player) {
  // Evolution Logic
  const evoData = EVOLUTIONS[player.name];
  if(evoData && evoData[player.level]) {
    const result = evoData[player.level];
    if(POKEMON_SPECIES[result]) {
      const oldName = player.name;
      player.name = result;
      player.maxHp += 15; player.hp += 15; player.atk += 10; player.def += 10;
      log(`‚ú® ¬°Tu ${oldName} evolucion√≥ a <b>${player.name}</b>!`);
      await wait(1000); 
    }
  }

  // Move Logic
  let newMove = null;

  if (state.gameMode === 'nuzlocke') {
    // Learn random move every 10 levels in Nuzlocke
    if (player.level % 10 === 0) {
      const allMoves = Object.keys(MOVES);
      newMove = allMoves[Math.floor(Math.random() * allMoves.length)];
    }
  } else {
    // Normal Mode
    if(evoData && evoData[player.level] && MOVES[evoData[player.level]]) {
      newMove = evoData[player.level];
    }
  }

  if (newMove && !player.moves.includes(newMove)) {
    if (player.moves.length < 4) {
      player.moves.push(newMove);
      log(`üí° ¬°${player.name} aprendi√≥ <b>${newMove}</b>!`);
    } else {
      // Prompt to forget
      await promptForgetMove(player, newMove);
    }
  }
}

function promptForgetMove(player, newMove) {
  return new Promise(resolve => {
    const overlay = $('move-overlay');
    const list = $('move-list');
    const cancelBtn = $('btn-cancel-learn');
    list.innerHTML = '';
    
    // Header
    const title = document.createElement('div');
    title.innerHTML = `<b>${player.name}</b> quiere aprender <b style="color:yellow">${newMove}</b>.`;
    title.style.marginBottom = '10px';
    title.style.textAlign = 'center';
    list.appendChild(title);

    // Current Moves
    player.moves.forEach((mKey, idx) => {
      const m = MOVES[mKey];
      const div = document.createElement('div');
      div.className = 'modal-card';
      div.innerHTML = `<span>${m.nombre}</span> <small>${m.tipo}/${m.poder}</small>`;
      div.onclick = () => {
        player.moves[idx] = newMove;
        log(`üí° ¬°${player.name} olvid√≥ ${m.nombre} y aprendi√≥ <b>${MOVES[newMove].nombre}</b>!`);
        overlay.style.display = 'none';
        resolve();
      };
      list.appendChild(div);
    });

    cancelBtn.onclick = () => {
      log(`‚ùå ${player.name} no aprendi√≥ ${MOVES[newMove].nombre}.`);
      overlay.style.display = 'none';
      resolve();
    }
    
    overlay.style.display = 'flex';
  });
}

function checkDefeat() {
  const alive = state.team.some(p => p.hp > 0);
  if(!alive) {
    log(`üíÄ Game Over. Racha final: ${state.streak}`);
    $('start-buttons').style.display = 'flex';
    $('btn-normal').innerText = 'Reintentar (Normal)';
    $('btn-nuzlocke').innerText = 'Reintentar (Nuzlocke)';
    turnLock = true; 
    renderAll();
  } else {
    openSwitchMenu(true);
  }
}

/* =========================================================
   ACTIONS
========================================================= */
function usePotion() {
  if (turnLock) return;
  const p = state.team[state.activeIdx];
  if(state.inventory.pots > 0 && p.hp < p.maxHp) {
    turnLock = true;
    state.inventory.pots--;
    const healAmount = Math.floor(p.maxHp * 0.60);
    p.hp = Math.min(p.maxHp, p.hp + healAmount);
    log(`üíä Usaste Poci√≥n. ${p.name} recuper√≥ ${healAmount} PS.`);
    renderAll();
    setTimeout(async () => {
      let oppMoveKey = null;
      if(opponent.moves.length > 0) {
        oppMoveKey = opponent.moves[Math.floor(Math.random() * opponent.moves.length)];
      }
      const oppMove = oppMoveKey ? MOVES[oppMoveKey] : null;

      await executeMove(opponent, p, oppMove, false);
      
      // Post-Turn Status Damage
      await runStatusDamage(p, true);
      if(p.hp > 0) await runStatusDamage(opponent, false);
      
      renderAll();

      if(p.hp <= 0) {
        log(`‚ò†Ô∏è ¬°${p.name} se debilit√≥!`);
        if (state.gameMode === 'nuzlocke') {
            log(`‚ö∞Ô∏è Nuzlocke: ¬°${p.name} ha muerto para siempre!`);
            state.team.splice(state.activeIdx, 1);
            state.activeIdx = -1;
        }
        checkDefeat();
      } else {
         turnLock = false;
         renderAll();
      }
    }, 1000);
  }
}

async function attemptCapture() {
  if(turnLock || state.inventory.balls <= 0) return;
  turnLock = true;
  state.inventory.balls--;
  renderAll();
  
  log(`üé± ¬°Lanzaste una Pok√©ball!`);
  
  const ball = document.createElement('div');
  ball.innerHTML = 'üé±';
  ball.style.position = 'absolute';
  ball.style.left = '20%'; ball.style.bottom = '20%'; ball.style.fontSize = '30px';
  ball.style.transition = 'all 0.5s ease-in';
  ball.style.zIndex = 100;
  $('battle-scene').appendChild(ball);
  
  setTimeout(() => { ball.style.left = '70%'; ball.style.top = '20%'; }, 50);
  
  await wait(600);
  ball.remove();
  
  const hpFactor = (opponent.maxHp - opponent.hp) / opponent.maxHp; 
  const statusBonus = opponent.status ? 0.2 : 0;
  const chance = 0.4 + (hpFactor * 0.5) + statusBonus; 
  
  if(Math.random() < chance) {
    log(`‚≠ê ¬°Capturaste a <b>${opponent.name}</b>!`);
    opponent.xp = 0;
    opponent.xpToNext = opponent.level * 60 + 100;
    opponent.hp = opponent.maxHp; 
    opponent.status = null; // Clear enemy status on capture

    if (state.team.length < CONSTANTS.MAX_TEAM) {
      state.team.push(opponent);
      await wait(1000);
      startBattle();
    } else {
      openPartyFullMenu(opponent);
    }
  } else {
    log(`üí¢ ¬°${opponent.name} se liber√≥!`);
    
    let oppMoveKey = null;
    if(opponent.moves.length > 0) {
      oppMoveKey = opponent.moves[Math.floor(Math.random() * opponent.moves.length)];
    }
    const oppMove = oppMoveKey ? MOVES[oppMoveKey] : null;

    await executeMove(opponent, state.team[state.activeIdx], oppMove, false);
    
    // Post-Turn Status Damage
    const p = state.team[state.activeIdx];
    await runStatusDamage(p, true);
    if(p.hp > 0) await runStatusDamage(opponent, false);

    renderAll();
    
    if(state.team[state.activeIdx] && state.team[state.activeIdx].hp <= 0) {
        const player = state.team[state.activeIdx];
        log(`‚ò†Ô∏è ¬°${player.name} se debilit√≥!`);
        if (state.gameMode === 'nuzlocke') {
            log(`‚ö∞Ô∏è Nuzlocke: ¬°${player.name} ha muerto para siempre!`);
            state.team.splice(state.activeIdx, 1);
            state.activeIdx = -1;
        }
        checkDefeat();
    } else {
        turnLock = false;
        renderAll();
    }
  }
}

function openPartyFullMenu(newMon) {
  const overlay = $('party-full-overlay');
  const list = $('party-full-list');
  list.innerHTML = '';
  
  state.team.forEach((p, idx) => {
    const div = document.createElement('div');
    const shiny = p.isShiny ? '‚ú®' : '';
    div.className = 'modal-card';
    div.innerHTML = `<span>${shiny}${p.name} (Nv${p.level})</span> <small>Liberar</small>`;
    div.onclick = async () => {
      log(`üëã Has liberado a ${p.name}. ¬°Bienvenido ${newMon.name}!`);
      state.team[idx] = newMon; // Replace
      overlay.style.display = 'none';
      await wait(1000);
      startBattle();
    };
    list.appendChild(div);
  });

  const btnReleaseNew = $('btn-release-new');
  btnReleaseNew.onclick = async () => {
    log(`üëã Liberaste a ${newMon.name}.`);
    overlay.style.display = 'none';
    await wait(1000);
    startBattle();
  };

  overlay.style.display = 'flex';
}

function openSwitchMenu(forced = false) {
  const overlay = $('switch-overlay');
  const list = $('switch-list');
  list.innerHTML = '';
  
  state.team.forEach((p, idx) => {
    const div = document.createElement('div');
    const fainted = p.hp <= 0;
    const shiny = p.isShiny ? '‚ú®' : '';
    const active = idx === state.activeIdx;
    
    div.className = `modal-card ${fainted ? 'fainted' : ''} ${active ? 'selected' : ''}`;
    div.innerHTML = `
      <span>${shiny}${p.name} (Nv${p.level})</span>
      <b>${p.hp}/${p.maxHp} HP</b>
    `;
    if(!fainted) {
      div.onclick = () => doSwitch(idx, forced);
    }
    list.appendChild(div);
  });
  
  overlay.style.display = 'flex';
  if(forced) $('switch-overlay').querySelector('button').style.display = 'none'; 
  else $('switch-overlay').querySelector('button').style.display = 'block'; 
}

function closeSwitchMenu() {
  $('switch-overlay').style.display = 'none';
}

function doSwitch(idx, forced) {
  if(idx === state.activeIdx && !state.team[idx].hp <= 0) {
    closeSwitchMenu();
    return;
  }
  
  state.activeIdx = idx;
  log(`üîÑ ¬°Adelante <b>${state.team[idx].name}</b>!`);
  closeSwitchMenu();
  renderAll();
  
  if(!forced) {
    turnLock = true;
    setTimeout(async () => {
      const p = state.team[state.activeIdx];
      const oppMoveKey = opponent.moves[Math.floor(Math.random()*opponent.moves.length)];
      const oppMove = oppMoveKey ? MOVES[oppMoveKey] : null;
      log(`üîª El rival aprovecha el cambio.`);
      await executeMove(opponent, p, oppMove, false);
      turnLock = false;
      renderAll();
      if(p.hp <= 0) checkDefeat();
    }, 1000);
  } else {
    turnLock = false;
    renderAll();
  }
}

function saveGame() {
  const data = JSON.stringify(state);
  localStorage.setItem('poke_save', data);
  alert('Partida guardada.');
  $('btn-load').disabled = false;
}

function loadGame() {
  const data = localStorage.getItem('poke_save');
  if(data) {
    try {
      const rawState = JSON.parse(data);
      state = rawState;
      // Data integrity checks
      state.team.forEach(p => {
        if(p.isShiny === undefined) p.isShiny = false;
        if(p.status === undefined) p.status = null;
      });
      if (!state.gameMode) state.gameMode = 'normal';

      $('start-buttons').style.display = 'none';
      $('game-title').classList.add('hidden-title');
      $('mode-display').innerText = state.gameMode === 'nuzlocke' ? '‚ò†Ô∏è Nuzlocke' : 'Normal';
      startBattle();
    } catch(e) {
      alert("Error al cargar partida.");
    }
  }
}
</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
